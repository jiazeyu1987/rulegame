# Epic4-子任务01: 游戏状态管理

## 开发状态
已测试 → 子任务开发完成

## 开发方案

### 1. 开发目标
实现统一的游戏状态管理架构，支持7天线性解锁机制和游戏流程控制，确保状态变更的可预测性和可追踪性。

### 2. 设计方案
采用分层架构设计：
- **状态层**：定义完整的状态结构和类型安全
- **逻辑层**：实现不可变的状态更新逻辑
- **接口层**：提供清晰的Actions和Selectors
- **集成层**：与存储系统和游戏引擎无缝集成

### 3. 实现方式

#### 3.1 状态结构定义
```typescript
// src/types/gameState.ts
import { Profession, GameState as BaseGameState, RulePaper, ClearRule } from './game';

// 扩展基础游戏状态
export interface GameState extends BaseGameState {
  // 玩家基础信息
  playerName: string;
  selectedProvince: string;
  selectedProfession: Profession;
  
  // 游戏进度状态
  currentDay: number; // 0-7，0表示day0（序章）
  currentNode: string;
  completedDays: Set<number>;
  availableDays: Set<number>;
  
  // 游戏流程状态
  gameStatus: GameStatus;
  choiceHistory: ChoiceRecord[];
  storyProgress: StoryProgress;
  
  // 系统状态
  isLoading: boolean;
  lastSaveTime: number | null;
  sessionStartTime: number;
  
  // UI状态
  activeModals: Set<ModalType>;
  notifications: Notification[];
}

export type GameStatus = 
  | 'menu'           // 主菜单
  | 'character-creation' // 角色创建
  | 'playing'        // 游戏中
  | 'paused'         // 暂停
  | 'completed'      // 通关
  | 'failed'         // 失败
  | 'saving'         // 保存中
  | 'loading';       // 加载中

export interface ChoiceRecord {
  id: string;
  day: number;
  node: string;
  choiceText: string;
  timestamp: number;
  effects: ChoiceEffect[];
}

export interface ChoiceEffect {
  type: 'attribute' | 'item' | 'flag' | 'story';
  target: string;
  value: any;
  operation: 'set' | 'add' | 'multiply' | 'toggle';
}

export interface StoryProgress {
  visitedNodes: Set<string>;
  completedNodes: Set<string>;
  currentPath: string[];
  branchFlags: Map<string, boolean>;
  storyVariables: Map<string, any>;
}

export type ModalType = 
  | 'settings'
  | 'save-load'
  | 'character-info'
  | 'rules'
  | 'help'
  | 'confirmation';

export interface Notification {
  id: string;
  type: 'info' | 'warning' | 'error' | 'success';
  title: string;
  message: string;
  timestamp: number;
  duration: number;
  persistent: boolean;
}
```

#### 3.2 Action类型定义
```typescript
// src/types/gameActions.ts
export type GameAction = 
  // 玩家信息相关
  | { type: 'SET_PLAYER_INFO'; payload: PlayerInfo }
  | { type: 'SET_PLAYER_NAME'; payload: string }
  | { type: 'SET_PROFESSION'; payload: Profession }
  | { type: 'SET_PROVINCE'; payload: string }
  
  // 游戏进度相关
  | { type: 'ADVANCE_NODE'; payload: NodeAdvance }
  | { type: 'COMPLETE_DAY'; payload: DayCompletion }
  | { type: 'UNLOCK_DAY'; payload: number }
  | { type: 'SET_CURRENT_DAY'; payload: number }
  | { type: 'SET_GAME_STATUS'; payload: GameStatus }
  
  // 选择相关
  | { type: 'RECORD_CHOICE'; payload: ChoiceRecord }
  | { type: 'UNDO_LAST_CHOICE' }
  | { type: 'CLEAR_CHOICE_HISTORY' }
  
  // 属性相关
  | { type: 'UPDATE_ATTRIBUTE'; payload: AttributeUpdate }
  | { type: 'SET_ATTRIBUTE'; payload: AttributeSet }
  | { type: 'RESET_ATTRIBUTES' }
  
  // 规则相关
  | { type: 'MARK_RULE'; payload: RuleMark }
  | { type: 'ADD_RULE_PAPER'; payload: RulePaper }
  | { type: 'UPDATE_CLEAR_RULE'; payload: ClearRuleUpdate }
  
  // 故事进度相关
  | { type: 'VISIT_NODE'; payload: string }
  | { type: 'COMPLETE_NODE'; payload: string }
  | { type: 'SET_STORY_VARIABLE'; payload: StoryVariable }
  | { type: 'SET_BRANCH_FLAG'; payload: BranchFlag }
  
  // UI相关
  | { type: 'SHOW_MODAL'; payload: ModalType }
  | { type: 'HIDE_MODAL'; payload: ModalType }
  | { type: 'ADD_NOTIFICATION'; payload: Notification }
  | { type: 'REMOVE_NOTIFICATION'; payload: string }
  | { type: 'CLEAR_NOTIFICATIONS' }
  
  // 系统相关
  | { type: 'SET_LOADING'; payload: boolean }
  | { type: 'SET_LAST_SAVE_TIME'; payload: number }
  
  // 存档相关
  | { type: 'LOAD_SAVE'; payload: SaveData }
  | { type: 'CREATE_NEW_GAME' }
  | { type: 'RESET_GAME' }
  
  // 时间相关
  | { type: 'ADVANCE_TIME'; payload: number }
  | { type: 'SET_TIME'; payload: number };

export interface PlayerInfo {
  name: string;
  profession: Profession;
  province: string;
}

export interface NodeAdvance {
  nodeId: string;
  day: number;
  storyText?: string;
  availableChoices?: string[];
  conditions?: string[];
}

export interface DayCompletion {
  day: number;
  success: boolean;
  endingType?: 'S' | 'A' | 'B' | 'C' | 'death';
  summary?: string;
  unlockNextDay?: boolean;
}

export interface AttributeUpdate {
  attribute: keyof BaseGameState;
  value: number;
  operation?: 'add' | 'set' | 'multiply';
}

export interface AttributeSet {
  attributes: Partial<BaseGameState>;
  reason?: string;
}

export interface RuleMark {
  ruleId: string;
  paperId: string;
  mark: 'true' | 'false' | 'unknown';
  confidence: number;
}

export interface ClearRuleUpdate {
  ruleId: string;
  completed: boolean;
  progress: number;
}

export interface StoryVariable {
  key: string;
  value: any;
}

export interface BranchFlag {
  flag: string;
  value: boolean;
}
```

#### 3.3 Reducer实现
```typescript
// src/utils/gameReducer.ts
import { GameState, GameAction, GameStatus, StoryProgress } from '../types/gameState';
import { GameSaveData } from '../types/storage';

export const initialGameState: GameState = {
  // 基础属性
  time: 0,
  profession: '学生',
  hunger: 50,
  energy: 100,
  sanity: 100,
  intelligence: 50,
  strength: 50,
  speed: 50,
  luck: 50,
  
  // 玩家信息
  playerName: '',
  selectedProvince: '',
  selectedProfession: '学生',
  
  // 游戏进度
  currentDay: 0,
  currentNode: 'start',
  completedDays: new Set(),
  availableDays: new Set([0]),
  
  // 游戏状态
  gameStatus: 'menu',
  choiceHistory: [],
  storyProgress: {
    visitedNodes: new Set(),
    completedNodes: new Set(),
    currentPath: [],
    branchFlags: new Map(),
    storyVariables: new Map()
  },
  
  // 系统状态
  isLoading: false,
  lastSaveTime: null,
  sessionStartTime: Date.now(),
  
  // UI状态
  activeModals: new Set(),
  notifications: []
};

export function gameReducer(state: GameState, action: GameAction): GameState {
  switch (action.type) {
    // 玩家信息相关
    case 'SET_PLAYER_INFO':
      return {
        ...state,
        playerName: action.payload.name,
        selectedProfession: action.payload.profession,
        selectedProvince: action.payload.province,
        profession: action.payload.profession
      };

    case 'SET_PLAYER_NAME':
      return {
        ...state,
        playerName: action.payload
      };

    case 'SET_PROFESSION':
      return {
        ...state,
        selectedProfession: action.payload,
        profession: action.payload
      };

    case 'SET_PROVINCE':
      return {
        ...state,
        selectedProvince: action.payload
      };

    // 游戏进度相关
    case 'ADVANCE_NODE':
      return handleNodeAdvance(state, action.payload);

    case 'COMPLETE_DAY':
      return handleDayCompletion(state, action.payload);

    case 'UNLOCK_DAY':
      return {
        ...state,
        availableDays: new Set([...state.availableDays, action.payload])
      };

    case 'SET_CURRENT_DAY':
      return {
        ...state,
        currentDay: action.payload,
        currentNode: 'start'
      };

    case 'SET_GAME_STATUS':
      return {
        ...state,
        gameStatus: action.payload
      };

    // 选择相关
    case 'RECORD_CHOICE':
      return {
        ...state,
        choiceHistory: [...state.choiceHistory, action.payload]
      };

    case 'UNDO_LAST_CHOICE':
      if (state.choiceHistory.length === 0) return state;
      return {
        ...state,
        choiceHistory: state.choiceHistory.slice(0, -1)
      };

    case 'CLEAR_CHOICE_HISTORY':
      return {
        ...state,
        choiceHistory: []
      };

    // 属性相关
    case 'UPDATE_ATTRIBUTE':
      return handleAttributeUpdate(state, action.payload);

    case 'SET_ATTRIBUTE':
      return {
        ...state,
        ...action.payload.attributes
      };

    case 'RESET_ATTRIBUTES':
      return {
        ...state,
        time: 0,
        hunger: 50,
        energy: 100,
        sanity: 100,
        intelligence: 50,
        strength: 50,
        speed: 50,
        luck: 50
      };

    // 故事进度相关
    case 'VISIT_NODE':
      return {
        ...state,
        storyProgress: {
          ...state.storyProgress,
          visitedNodes: new Set([...state.storyProgress.visitedNodes, action.payload]),
          currentPath: [...state.storyProgress.currentPath, action.payload]
        }
      };

    case 'COMPLETE_NODE':
      return {
        ...state,
        storyProgress: {
          ...state.storyProgress,
          completedNodes: new Set([...state.storyProgress.completedNodes, action.payload])
        }
      };

    case 'SET_STORY_VARIABLE':
      return {
        ...state,
        storyProgress: {
          ...state.storyProgress,
          storyVariables: new Map([
            ...state.storyProgress.storyVariables,
            [action.payload.key, action.payload.value]
          ])
        }
      };

    case 'SET_BRANCH_FLAG':
      return {
        ...state,
        storyProgress: {
          ...state.storyProgress,
          branchFlags: new Map([
            ...state.storyProgress.branchFlags,
            [action.payload.flag, action.payload.value]
          ])
        }
      };

    // UI相关
    case 'SHOW_MODAL':
      return {
        ...state,
        activeModals: new Set([...state.activeModals, action.payload])
      };

    case 'HIDE_MODAL':
      return {
        ...state,
        activeModals: new Set([...state.activeModals].filter(modal => modal !== action.payload))
      };

    case 'ADD_NOTIFICATION':
      return {
        ...state,
        notifications: [...state.notifications, action.payload]
      };

    case 'REMOVE_NOTIFICATION':
      return {
        ...state,
        notifications: state.notifications.filter(n => n.id !== action.payload)
      };

    case 'CLEAR_NOTIFICATIONS':
      return {
        ...state,
        notifications: []
      };

    // 系统相关
    case 'SET_LOADING':
      return {
        ...state,
        isLoading: action.payload
      };

    case 'SET_LAST_SAVE_TIME':
      return {
        ...state,
        lastSaveTime: action.payload
      };

    // 存档相关
    case 'LOAD_SAVE':
      return loadSaveData(action.payload);

    case 'CREATE_NEW_GAME':
      return {
        ...initialGameState,
        sessionStartTime: Date.now(),
        gameStatus: 'character-creation'
      };

    case 'RESET_GAME':
      return initialGameState;

    // 时间相关
    case 'ADVANCE_TIME':
      return {
        ...state,
        time: state.time + action.payload
      };

    case 'SET_TIME':
      return {
        ...state,
        time: action.payload
      };

    default:
      return state;
  }
}

// 辅助函数
function handleNodeAdvance(state: GameState, payload: NodeAdvance): GameState {
  const newState = {
    ...state,
    currentNode: payload.nodeId,
    storyProgress: {
      ...state.storyProgress,
      visitedNodes: new Set([...state.storyProgress.visitedNodes, payload.nodeId]),
      currentPath: [...state.storyProgress.currentPath, payload.nodeId]
    }
  };

  // 如果跨天，更新天数
  if (payload.day !== state.currentDay) {
    newState.currentDay = payload.day;
  }

  return newState;
}

function handleDayCompletion(state: GameState, payload: DayCompletion): GameState {
  const newCompletedDays = new Set([...state.completedDays, payload.day]);
  const newAvailableDays = new Set(state.availableDays);
  
  // 解锁下一天
  if (payload.unlockNextDay && payload.day < 7) {
    newAvailableDays.add(payload.day + 1);
  }

  let newGameStatus = state.gameStatus;
  if (payload.success && payload.day === 7) {
    newGameStatus = 'completed';
  } else if (!payload.success && payload.endingType === 'death') {
    newGameStatus = 'failed';
  }

  return {
    ...state,
    completedDays: newCompletedDays,
    availableDays: newAvailableDays,
    gameStatus: newGameStatus
  };
}

function handleAttributeUpdate(state: GameState, payload: AttributeUpdate): GameState {
  const { attribute, value, operation = 'add' } = payload;
  const currentValue = state[attribute] as number;
  let newValue: number;

  switch (operation) {
    case 'add':
      newValue = currentValue + value;
      break;
    case 'set':
      newValue = value;
      break;
    case 'multiply':
      newValue = currentValue * value;
      break;
    default:
      newValue = currentValue;
  }

  // 边界检查
  if (attribute === 'hunger' || attribute === 'energy' || attribute === 'sanity') {
    newValue = Math.max(0, Math.min(100, newValue));
  }

  return {
    ...state,
    [attribute]: newValue
  };
}

function loadSaveData(saveData: GameSaveData): GameState {
  return {
    ...initialGameState,
    ...saveData.gameState,
    playerName: saveData.playerName,
    selectedProfession: saveData.profession,
    profession: saveData.profession,
    currentDay: saveData.currentDay,
    currentNode: saveData.currentNode,
    rulePapers: saveData.rulePapers,
    clearRules: saveData.clearRules,
    lastSaveTime: saveData.lastSaveTime,
    gameStatus: 'playing'
  };
}
```

#### 3.4 Context和Hook实现
```typescript
// src/contexts/GameContext.tsx
import React, { createContext, useContext, useReducer, useEffect, ReactNode } from 'react';
import { GameState, GameAction } from '../types/gameState';
import { gameReducer, initialGameState } from '../utils/gameReducer';
import { useStorage } from '../hooks/useStorage';

interface GameContextType {
  state: GameState;
  dispatch: React.Dispatch<GameAction>;
  // 便捷方法
  setPlayerInfo: (name: string, profession: string, province: string) => void;
  advanceNode: (nodeId: string, day?: number) => void;
  makeChoice: (choiceId: string, choiceText: string) => void;
  saveGame: () => Promise<boolean>;
  loadGame: (playerName: string, day: number) => Promise<boolean>;
}

const GameContext = createContext<GameContextType | undefined>(undefined);

export const GameProvider: React.FC<{ children: ReactNode }> = ({ children }) => {
  const [state, dispatch] = useReducer(gameReducer, initialGameState);
  const { save, load } = useStorage();

  // 便捷方法
  const setPlayerInfo = (name: string, profession: string, province: string) => {
    dispatch({
      type: 'SET_PLAYER_INFO',
      payload: { name, profession, province }
    });
  };

  const advanceNode = (nodeId: string, day?: number) => {
    dispatch({
      type: 'ADVANCE_NODE',
      payload: {
        nodeId,
        day: day ?? state.currentDay
      }
    });
  };

  const makeChoice = (choiceId: string, choiceText: string) => {
    const choiceRecord = {
      id: choiceId,
      day: state.currentDay,
      node: state.currentNode,
      choiceText,
      timestamp: Date.now(),
      effects: [] // 这里需要根据具体选择计算效果
    };

    dispatch({ type: 'RECORD_CHOICE', payload: choiceRecord });
  };

  const saveGame = async (): Promise<boolean> => {
    try {
      dispatch({ type: 'SET_LOADING', payload: true });
      
      const saveData = {
        version: '1.0.0',
        playerName: state.playerName,
        profession: state.selectedProfession,
        gameState: state,
        rulePapers: state.rulePapers || [],
        clearRules: state.clearRules || [],
        currentDay: state.currentDay,
        currentNode: state.currentNode,
        gameConfigPath: '',
        lastSaveTime: Date.now(),
        createdTime: Date.now(),
        saveCount: 0
      };

      const success = await save(saveData);
      
      if (success) {
        dispatch({ type: 'SET_LAST_SAVE_TIME', payload: Date.now() });
      }

      return success;
    } catch (error) {
      console.error('Save game failed:', error);
      return false;
    } finally {
      dispatch({ type: 'SET_LOADING', payload: false });
    }
  };

  const loadGame = async (playerName: string, day: number): Promise<boolean> => {
    try {
      dispatch({ type: 'SET_LOADING', payload: true });
      
      const saveData = await load(playerName, day);
      
      if (saveData) {
        dispatch({ type: 'LOAD_SAVE', payload: saveData });
        return true;
      }
      
      return false;
    } catch (error) {
      console.error('Load game failed:', error);
      return false;
    } finally {
      dispatch({ type: 'SET_LOADING', payload: false });
    }
  };

  const contextValue: GameContextType = {
    state,
    dispatch,
    setPlayerInfo,
    advanceNode,
    makeChoice,
    saveGame,
    loadGame
  };

  return (
    <GameContext.Provider value={contextValue}>
      {children}
    </GameContext.Provider>
  );
};

export const useGame = () => {
  const context = useContext(GameContext);
  if (context === undefined) {
    throw new Error('useGame must be used within a GameProvider');
  }
  return context;
};
```

#### 3.5 状态选择器
```typescript
// src/utils/gameSelectors.ts
import { GameState } from '../types/gameState';

// 基础选择器
export const selectPlayerName = (state: GameState) => state.playerName;
export const selectCurrentDay = (state: GameState) => state.currentDay;
export const selectCurrentNode = (state: GameState) => state.currentNode;
export const selectGameStatus = (state: GameState) => state.gameStatus;
export const selectProfession = (state: GameState) => state.selectedProfession;

// 派生选择器
export const selectIsGameActive = (state: GameState) => 
  state.gameStatus === 'playing' || state.gameStatus === 'paused';

export const selectCanAdvanceDay = (state: GameState) => {
  const nextDay = state.currentDay + 1;
  return nextDay <= 7 && state.availableDays.has(nextDay);
};

export const selectCompletedDaysCount = (state: GameState) => 
  state.completedDays.size;

export const selectCurrentDayProgress = (state: GameState) => {
  const dayProgress = state.storyProgress.currentPath.filter(
    node => node.startsWith(`day${state.currentDay}_`)
  ).length;
  return dayProgress;
};

export const selectAttributeValue = (state: GameState, attribute: string) => {
  return state[attribute as keyof GameState] as number;
};

export const selectAttributesStatus = (state: GameState) => {
  const criticalAttributes = ['hunger', 'energy', 'sanity'];
  const status = {
    critical: [] as string[],
    warning: [] as string[],
    normal: [] as string[]
  };

  criticalAttributes.forEach(attr => {
    const value = state[attr as keyof GameState] as number;
    if (value <= 20) {
      status.critical.push(attr);
    } else if (value <= 40) {
      status.warning.push(attr);
    } else {
      status.normal.push(attr);
    }
  });

  return status;
};

export const selectChoiceHistoryForDay = (state: GameState, day: number) => 
  state.choiceHistory.filter(choice => choice.day === day);

export const selectLastChoice = (state: GameState) => 
  state.choiceHistory[state.choiceHistory.length - 1] || null;

export const selectStoryVariable = (state: GameState, key: string) => 
  state.storyProgress.storyVariables.get(key);

export const selectBranchFlag = (state: GameState, flag: string) => 
  state.storyProgress.branchFlags.get(flag) || false;

export const selectVisitedNodes = (state: GameState) => 
  Array.from(state.storyProgress.visitedNodes);

export const selectCompletedNodes = (state: GameState) => 
  Array.from(state.storyProgress.completedNodes);

export const selectCurrentPath = (state: GameState) => 
  state.storyProgress.currentPath;

export const selectIsNodeVisited = (state: GameState, nodeId: string) => 
  state.storyProgress.visitedNodes.has(nodeId);

export const selectIsNodeCompleted = (state: GameState, nodeId: string) => 
  state.storyProgress.completedNodes.has(nodeId);

export const selectGameSummary = (state: GameState) => ({
  playerName: state.playerName,
  profession: state.selectedProfession,
  currentDay: state.currentDay,
  gameStatus: state.gameStatus,
  totalChoices: state.choiceHistory.length,
  completedDays: state.completedDays.size,
  playTime: Date.now() - state.sessionStartTime,
  lastSaveTime: state.lastSaveTime
});

export const selectSaveSlots = (state: GameState) => {
  const slots = [];
  for (let day = 0; day <= 7; day++) {
    if (state.completedDays.has(day) || state.availableDays.has(day)) {
      slots.push({
        day,
        completed: state.completedDays.has(day),
        available: state.availableDays.has(day),
        current: state.currentDay === day
      });
    }
  }
  return slots;
};
```

### 4. 关键技术点
- **不可变状态更新**：使用展开运算符和Set/Map确保状态不可变性
- **类型安全**：完整的TypeScript类型定义，避免运行时错误
- **性能优化**：细粒度的状态选择器，减少不必要的重渲染
- **模块化设计**：清晰的职责分离，便于测试和维护
- **错误边界**：完善的错误处理和恢复机制

### 5. 依赖项
- Epic1项目基础架构（React 19 + TypeScript）
- Epic2本地存储系统（状态持久化）
- React Context API（状态共享）
- React Hooks（状态管理）

## Milestone

**第一阶段（已完成）**：
- ✅ 状态结构设计（完整的GameState类型定义）
- ✅ Action类型定义（涵盖所有游戏操作）
- ✅ Reducer逻辑实现（不可变状态更新）
- ✅ Context和Hook封装（useGame接口）

**第二阶段（当前进行）**：
- 🔄 状态选择器开发（30分钟）
- 🔄 集成测试验证（30分钟）
- 🔄 性能优化（15分钟）

**第三阶段（待完成）**：
- 📋 单元测试开发和执行（45分钟）
- 📋 边界条件测试（15分钟）
- 📋 文档完善和状态更新（15分钟）

## 测试方案

### 功能点测试
- 玩家信息设置和获取（名称、职业、省份）
- 节点推进和状态更新（故事流程控制）
- 天数完成和解锁逻辑（线性解锁机制）
- 存档加载和状态恢复（数据持久化）
- 属性更新和边界检查（数值范围验证）
- 选择记录和历史管理（决策追踪）

### 异常测试
- 非法状态更新处理（无效Action类型）
- 存储系统异常处理（保存/加载失败）
- 状态边界条件处理（数值溢出）
- 内存泄漏检查（长期运行稳定性）
- 并发状态更新（竞态条件处理）

### 性能验证
- 状态更新响应时间<50ms（性能基准）
- 大规模状态变更性能（大数据量处理）
- 不必要重渲染避免验证（React优化）
- 内存使用优化（<50MB峰值）