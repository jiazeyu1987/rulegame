# Epic5-子任务01: 基础UI组件开发

## 开发状态
已测试 → 子任务开发完成

## 开发方案

### 1. 开发目标
构建游戏界面基础组件库，包括文本显示、选择按钮、进度指示等核心UI元素。

### 2. 设计方案
- 组件化设计，支持复用和扩展
- TypeScript类型安全的props接口
- CSS Modules实现样式隔离
- 响应式布局支持

### 3. 实现方式

#### 3.1 故事文本组件 (StoryText)
```typescript
// src/components/ui/StoryText.tsx
import React, { useState, useEffect, useRef } from 'react';
import styles from './StoryText.module.css';

export interface StoryTextProps {
  content: string;
  speed?: 'slow' | 'normal' | 'fast';
  onComplete?: () => void;
  className?: string;
  showCursor?: boolean;
  cursorChar?: string;
}

const SPEED_MAP = {
  slow: 100,
  normal: 50,
  fast: 25
};

export const StoryText: React.FC<StoryTextProps> = React.memo(({
  content,
  speed = 'normal',
  onComplete,
  className = '',
  showCursor = true,
  cursorChar = '▊'
}) => {
  const [displayText, setDisplayText] = useState('');
  const [currentIndex, setCurrentIndex] = useState(0);
  const [isComplete, setIsComplete] = useState(false);
  const intervalRef = useRef<NodeJS.Timeout | null>(null);

  useEffect(() => {
    // 重置状态
    setDisplayText('');
    setCurrentIndex(0);
    setIsComplete(false);

    // 开始打字机效果
    const typingSpeed = SPEED_MAP[speed];
    
    intervalRef.current = setInterval(() => {
      setCurrentIndex(prev => {
        const nextIndex = prev + 1;
        
        if (nextIndex > content.length) {
          // 完成打字
          if (intervalRef.current) {
            clearInterval(intervalRef.current);
          }
          setIsComplete(true);
          onComplete?.();
          return prev;
        }
        
        setDisplayText(content.slice(0, nextIndex));
        return nextIndex;
      });
    }, typingSpeed);

    return () => {
      if (intervalRef.current) {
        clearInterval(intervalRef.current);
      }
    };
  }, [content, speed, onComplete]);

  const handleSkip = () => {
    if (intervalRef.current) {
      clearInterval(intervalRef.current);
    }
    setDisplayText(content);
    setCurrentIndex(content.length);
    setIsComplete(true);
    onComplete?.();
  };

  return (
    <div className={`${styles.storyText} ${className}`}>
      <div className={styles.textContent}>
        {displayText}
        {showCursor && !isComplete && (
          <span className={styles.cursor}>{cursorChar}</span>
        )}
      </div>
      {!isComplete && (
        <button 
          className={styles.skipButton}
          onClick={handleSkip}
          aria-label="跳过文本动画"
        >
          跳过
        </button>
      )}
    </div>
  );
});

StoryText.displayName = 'StoryText';
```

```css
/* src/components/ui/StoryText.module.css */
.storyText {
  position: relative;
  padding: 1.5rem;
  background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
  border: 1px solid #0f3460;
  border-radius: 8px;
  color: #e94560;
  font-family: 'Courier New', monospace;
  font-size: 1.1rem;
  line-height: 1.8;
  min-height: 120px;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
}

.textContent {
  white-space: pre-wrap;
  word-wrap: break-word;
}

.cursor {
  display: inline-block;
  animation: blink 1s infinite;
  color: #e94560;
  font-weight: bold;
}

@keyframes blink {
  0%, 50% { opacity: 1; }
  51%, 100% { opacity: 0; }
}

.skipButton {
  position: absolute;
  top: 0.5rem;
  right: 0.5rem;
  padding: 0.25rem 0.5rem;
  background: rgba(233, 69, 96, 0.2);
  border: 1px solid #e94560;
  color: #e94560;
  border-radius: 4px;
  font-size: 0.8rem;
  cursor: pointer;
  transition: all 0.3s ease;
}

.skipButton:hover {
  background: rgba(233, 69, 96, 0.4);
  transform: translateY(-1px);
}

@media (max-width: 768px) {
  .storyText {
    padding: 1rem;
    font-size: 1rem;
  }
}
```

#### 3.2 选择按钮组件 (ChoiceButton)
```typescript
// src/components/ui/ChoiceButton.tsx
import React, { useState } from 'react';
import styles from './ChoiceButton.module.css';

export interface ChoiceButtonProps {
  text: string;
  onClick: () => void;
  disabled?: boolean;
  variant?: 'primary' | 'secondary' | 'danger';
  size?: 'small' | 'medium' | 'large';
  loading?: boolean;
  icon?: React.ReactNode;
  className?: string;
  ariaLabel?: string;
}

export const ChoiceButton: React.FC<ChoiceButtonProps> = React.memo(({
  text,
  onClick,
  disabled = false,
  variant = 'primary',
  size = 'medium',
  loading = false,
  icon,
  className = '',
  ariaLabel
}) => {
  const [isPressed, setIsPressed] = useState(false);

  const handleClick = () => {
    if (!disabled && !loading) {
      setIsPressed(true);
      onClick();
      setTimeout(() => setIsPressed(false), 150);
    }
  };

  const handleKeyDown = (e: React.KeyboardEvent) => {
    if (e.key === 'Enter' || e.key === ' ') {
      e.preventDefault();
      handleClick();
    }
  };

  const buttonClasses = `
    ${styles.choiceButton}
    ${styles[variant]}
    ${styles[size]}
    ${loading ? styles.loading : ''}
    ${isPressed ? styles.pressed : ''}
    ${disabled ? styles.disabled : ''}
    ${className}
  `.trim();

  return (
    <button
      className={buttonClasses}
      onClick={handleClick}
      onKeyDown={handleKeyDown}
      disabled={disabled || loading}
      aria-label={ariaLabel || text}
      aria-disabled={disabled || loading}
      aria-pressed={isPressed}
    >
      {loading && (
        <span className={styles.spinner} aria-hidden="true">
          ⟳
        </span>
      )}
      {icon && !loading && (
        <span className={styles.icon} aria-hidden="true">
          {icon}
        </span>
      )}
      <span className={styles.text}>{text}</span>
    </button>
  );
});

ChoiceButton.displayName = 'ChoiceButton';
```

```css
/* src/components/ui/ChoiceButton.module.css */
.choiceButton {
  position: relative;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
  padding: 0.75rem 1.5rem;
  border: none;
  border-radius: 6px;
  font-family: inherit;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  user-select: none;
  outline: none;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
}

.choiceButton:focus-visible {
  outline: 2px solid #60a5fa;
  outline-offset: 2px;
}

/* 主要变体 */
.primary {
  background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
  color: white;
}

.primary:hover:not(:disabled) {
  background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
  transform: translateY(-2px);
  box-shadow: 0 4px 16px rgba(59, 130, 246, 0.3);
}

/* 次要变体 */
.secondary {
  background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
  color: white;
}

.secondary:hover:not(:disabled) {
  background: linear-gradient(135deg, #4b5563 0%, #374151 100%);
  transform: translateY(-2px);
  box-shadow: 0 4px 16px rgba(107, 114, 128, 0.3);
}

/* 危险变体 */
.danger {
  background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
  color: white;
}

.danger:hover:not(:disabled) {
  background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
  transform: translateY(-2px);
  box-shadow: 0 4px 16px rgba(239, 68, 68, 0.3);
}

/* 尺寸变体 */
.small {
  padding: 0.5rem 1rem;
  font-size: 0.875rem;
}

.medium {
  padding: 0.75rem 1.5rem;
  font-size: 1rem;
}

.large {
  padding: 1rem 2rem;
  font-size: 1.125rem;
}

/* 状态变体 */
.pressed {
  transform: scale(0.95);
}

.disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none !important;
}

.loading {
  cursor: wait;
}

/* 加载动画 */
.spinner {
  display: inline-block;
  animation: spin 1s linear infinite;
  font-size: 1.2em;
}

@keyframes spin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

.icon {
  display: inline-flex;
  align-items: center;
}

.text {
  white-space: nowrap;
}

@media (max-width: 768px) {
  .choiceButton {
    padding: 0.625rem 1.25rem;
    font-size: 0.875rem;
  }
}
```

#### 3.3 进度指示器组件 (ProgressIndicator)
```typescript
// src/components/ui/ProgressIndicator.tsx
import React from 'react';
import styles from './ProgressIndicator.module.css';

export interface ProgressIndicatorProps {
  currentDay: number;
  completedDays: number[];
  totalDays: number;
  onDayClick?: (day: number) => void;
  showLabels?: boolean;
  size?: 'small' | 'medium' | 'large';
  variant?: 'linear' | 'circular' | 'calendar';
}

export const ProgressIndicator: React.FC<ProgressIndicatorProps> = React.memo(({
  currentDay,
  completedDays,
  totalDays,
  onDayClick,
  showLabels = true,
  size = 'medium',
  variant = 'linear'
}) => {
  const getDayStatus = (day: number) => {
    if (completedDays.includes(day)) return 'completed';
    if (day === currentDay) return 'current';
    if (day < currentDay) return 'available';
    return 'locked';
  };

  const getProgressPercentage = () => {
    return (completedDays.length / totalDays) * 100;
  };

  const handleDayClick = (day: number) => {
    if (onDayClick && day <= currentDay) {
      onDayClick(day);
    }
  };

  const renderLinearProgress = () => (
    <div className={styles.linearContainer}>
      <div className={styles.progressBar}>
        <div 
          className={styles.progressFill}
          style={{ width: `${getProgressPercentage()}%` }}
        />
      </div>
      <div className={styles.progressInfo}>
        <span className={styles.progressText}>
          进度: {completedDays.length}/{totalDays} 天
        </span>
        <span className={styles.currentDayText}>
          当前: 第{currentDay + 1}天
        </span>
      </div>
    </div>
  );

  const renderCalendarProgress = () => (
    <div className={styles.calendarContainer}>
      <div className={`${styles.calendarGrid} ${styles[size]}`}>
        {Array.from({ length: totalDays }, (_, index) => {
          const day = index;
          const status = getDayStatus(day);
          
          return (
            <button
              key={day}
              className={`${styles.dayCell} ${styles[status]} ${styles[size]}`}
              onClick={() => handleDayClick(day)}
              disabled={day > currentDay}
              aria-label={`第${day + 1}天 - ${getStatusText(status)}`}
            >
              <span className={styles.dayNumber}>{day + 1}</span>
              {showLabels && (
                <span className={styles.dayLabel}>
                  {getDayLabel(day, status)}
                </span>
              )}
              {status === 'completed' && (
                <span className={styles.checkMark} aria-hidden="true">✓</span>
              )}
              {status === 'current' && (
                <span className={styles.currentIndicator} aria-hidden="true">●</span>
              )}
            </button>
          );
        })}
      </div>
      {showLabels && (
        <div className={styles.legend}>
          <div className={styles.legendItem}>
            <span className={`${styles.legendDot} ${styles.completed}`}></span>
            <span>已完成</span>
          </div>
          <div className={styles.legendItem}>
            <span className={`${styles.legendDot} ${styles.current}`}></span>
            <span>当前</span>
          </div>
          <div className={styles.legendItem}>
            <span className={`${styles.legendDot} ${styles.available}`}></span>
            <span>可访问</span>
          </div>
          <div className={styles.legendItem}>
            <span className={`${styles.legendDot} ${styles.locked}`}></span>
            <span>未解锁</span>
          </div>
        </div>
      )}
    </div>
  );

  const getStatusText = (status: string) => {
    const statusMap = {
      completed: '已完成',
      current: '当前进行',
      available: '可访问',
      locked: '未解锁'
    };
    return statusMap[status as keyof typeof statusMap] || '未知';
  };

  const getDayLabel = (day: number, status: string) => {
    if (status === 'completed') return '完成';
    if (status === 'current') return '当前';
    return `第${day + 1}天`;
  };

  return (
    <div className={`${styles.progressIndicator} ${styles[size]} ${styles[variant]}`}>
      {variant === 'linear' && renderLinearProgress()}
      {variant === 'calendar' && renderCalendarProgress()}
    </div>
  );
});

ProgressIndicator.displayName = 'ProgressIndicator';
```

```css
/* src/components/ui/ProgressIndicator.module.css */
.progressIndicator {
  width: 100%;
  padding: 1rem;
}

/* 线性进度条样式 */
.linearContainer {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.progressBar {
  width: 100%;
  height: 8px;
  background: #e5e7eb;
  border-radius: 4px;
  overflow: hidden;
  position: relative;
}

.progressFill {
  height: 100%;
  background: linear-gradient(90deg, #3b82f6 0%, #1d4ed8 100%);
  border-radius: 4px;
  transition: width 0.5s ease;
  position: relative;
}

.progressFill::after {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(
    90deg,
    transparent 0%,
    rgba(255, 255, 255, 0.3) 50%,
    transparent 100%
  );
  animation: shimmer 2s infinite;
}

@keyframes shimmer {
  0% { transform: translateX(-100%); }
  100% { transform: translateX(100%); }
}

.progressInfo {
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 0.875rem;
  color: #6b7280;
}

.progressText {
  font-weight: 500;
}

.currentDayText {
  color: #3b82f6;
  font-weight: 600;
}

/* 日历样式 */
.calendarContainer {
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.calendarGrid {
  display: grid;
  gap: 0.5rem;
}

.calendarGrid.small {
  grid-template-columns: repeat(auto-fit, minmax(40px, 1fr));
}

.calendarGrid.medium {
  grid-template-columns: repeat(auto-fit, minmax(60px, 1fr));
}

.calendarGrid.large {
  grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
}

.dayCell {
  position: relative;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 0.5rem;
  border: 2px solid transparent;
  border-radius: 8px;
  background: #f9fafb;
  cursor: pointer;
  transition: all 0.3s ease;
  min-height: 60px;
}

.dayCell:focus-visible {
  outline: 2px solid #3b82f6;
  outline-offset: 2px;
}

.dayCell:disabled {
  cursor: not-allowed;
  opacity: 0.5;
}

.dayCell:not(:disabled):hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

/* 状态样式 */
.completed {
  background: linear-gradient(135deg, #10b981 0%, #059669 100%);
  color: white;
  border-color: #10b981;
}

.current {
  background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
  color: white;
  border-color: #3b82f6;
  animation: pulse 2s infinite;
}

.available {
  background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
  color: white;
  border-color: #f59e0b;
}

.locked {
  background: #e5e7eb;
  color: #9ca3af;
  border-color: #d1d5db;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.8; }
}

.dayNumber {
  font-size: 1.25rem;
  font-weight: bold;
  line-height: 1;
}

.dayLabel {
  font-size: 0.75rem;
  margin-top: 0.25rem;
  opacity: 0.9;
}

.checkMark {
  position: absolute;
  top: 2px;
  right: 2px;
  font-size: 0.75rem;
  color: inherit;
}

.currentIndicator {
  position: absolute;
  top: 2px;
  right: 2px;
  font-size: 0.5rem;
  color: inherit;
  animation: pulse 1.5s infinite;
}

/* 图例 */
.legend {
  display: flex;
  justify-content: center;
  gap: 1rem;
  flex-wrap: wrap;
  margin-top: 1rem;
  padding-top: 1rem;
  border-top: 1px solid #e5e7eb;
}

.legendItem {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-size: 0.75rem;
  color: #6b7280;
}

.legendDot {
  width: 12px;
  height: 12px;
  border-radius: 50%;
}

/* 响应式设计 */
@media (max-width: 768px) {
  .calendarGrid {
    grid-template-columns: repeat(4, 1fr) !important;
  }
  
  .dayCell {
    min-height: 50px;
    padding: 0.375rem;
  }
  
  .dayNumber {
    font-size: 1rem;
  }
  
  .dayLabel {
    font-size: 0.625rem;
  }
  
  .legend {
    gap: 0.5rem;
  }
}

@media (max-width: 480px) {
  .calendarGrid {
    grid-template-columns: repeat(3, 1fr) !important;
  }
}
```

#### 3.4 组件导出和类型定义
```typescript
// src/components/ui/index.ts
export { StoryText } from './StoryText';
export { ChoiceButton } from './ChoiceButton';
export { ProgressIndicator } from './ProgressIndicator';
export type { 
  StoryTextProps,
  ChoiceButtonProps,
  ProgressIndicatorProps 
} from './types';

// src/components/ui/types.ts
export interface StoryTextProps {
  content: string;
  speed?: 'slow' | 'normal' | 'fast';
  onComplete?: () => void;
  className?: string;
  showCursor?: boolean;
  cursorChar?: string;
}

export interface ChoiceButtonProps {
  text: string;
  onClick: () => void;
  disabled?: boolean;
  variant?: 'primary' | 'secondary' | 'danger';
  size?: 'small' | 'medium' | 'large';
  loading?: boolean;
  icon?: React.ReactNode;
  className?: string;
  ariaLabel?: string;
}

export interface ProgressIndicatorProps {
  currentDay: number;
  completedDays: number[];
  totalDays: number;
  onDayClick?: (day: number) => void;
  showLabels?: boolean;
  size?: 'small' | 'medium' | 'large';
  variant?: 'linear' | 'circular' | 'calendar';
}
```

### 4. 关键技术点
- 组件性能优化（React.memo）
- 可访问性支持（ARIA标签）
- 键盘导航实现
- 移动端触摸事件处理

### 5. 依赖项
- Epic1项目基础架构
- React组件生命周期
- CSS Modules
- TypeScript类型系统

## Milestone

- Day 1: 核心组件架构和StoryText组件
- Day 2: ChoiceButton和交互组件开发
- Day 3: 进度指示器和组件集成测试

## 测试方案

### 功能点测试
- 组件props正确传递
- 事件处理正常触发
- 样式应用正确性
- 响应式布局验证

### 异常测试
- 非法props处理
- 事件处理异常捕获
- 样式加载失败处理
- 内存泄漏检查

### 性能验证
- 组件渲染性能测试
- 不必要重渲染避免
- 大文本内容处理性能
- 移动端性能表现