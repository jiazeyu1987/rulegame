# Epic9-子任务01: 界面过渡效果和优化

## 开发状态
子任务开发完成

## 开发方案

### 1. 开发目标
实现统一的界面过渡效果和UI优化，包括淡入淡出动画、日历式进度展示等视觉增强功能。

### 2. 设计方案
- 使用CSS3动画和React Hooks
- 实现可配置的动画系统
- 日历式进度组件设计
- 性能优化和可访问性支持

### 3. 实现方式

#### 核心类型定义
```typescript
// 过渡效果类型
export type TransitionType = 'fade' | 'slide' | 'zoom' | 'flip' | 'bounce';

// 过渡方向
export type TransitionDirection = 'up' | 'down' | 'left' | 'right';

// 动画配置接口
export interface AnimationConfig {
  duration?: number;           // 动画持续时间(ms)
  delay?: number;              // 延迟时间(ms)
  easing?: string;             // 缓动函数
  direction?: TransitionDirection; // 方向(对于slide效果)
  disabled?: boolean;          // 是否禁用动画
}

// 过渡效果包装器属性
export interface TransitionWrapperProps {
  children: React.ReactNode;
  type: TransitionType;
  config?: AnimationConfig;
  trigger: boolean;            // 触发动画的条件
  className?: string;
  onStart?: () => void;        // 动画开始回调
  onEnd?: () => void;          // 动画结束回调
}

// 日历进度组件属性
export interface CalendarProgressProps {
  currentDay: number;          // 当前天数(1-7)
  totalDays: number;           // 总天数
  completedDays: number[];     // 已完成的天数数组
  onDayClick?: (day: number) => void; // 点击日期回调
  theme?: 'light' | 'dark';    // 主题
  size?: 'small' | 'medium' | 'large'; // 尺寸
}

// 日期项状态
export type DayStatus = 'completed' | 'current' | 'upcoming' | 'locked';

// 日期项接口
export interface DayItem {
  day: number;
  status: DayStatus;
  isClickable: boolean;
  label: string;
}
```

#### 过渡效果包装器实现
```typescript
import React, { useState, useEffect, useRef } from 'react';
import './TransitionWrapper.css';

const TransitionWrapper: React.FC<TransitionWrapperProps> = ({
  children,
  type,
  config = {},
  trigger,
  className = '',
  onStart,
  onEnd
}) => {
  const [isVisible, setIsVisible] = useState(false);
  const [isAnimating, setIsAnimating] = useState(false);
  const elementRef = useRef<HTMLDivElement>(null);
  const animationRef = useRef<number>();

  const {
    duration = 300,
    delay = 0,
    easing = 'ease-out',
    direction = 'up',
    disabled = false
  } = config;

  useEffect(() => {
    if (disabled) {
      setIsVisible(trigger);
      return;
    }

    if (trigger && !isVisible) {
      // 开始显示动画
      setIsAnimating(true);
      onStart?.();
      
      const startAnimation = () => {
        setIsVisible(true);
        
        // 清理之前的动画
        if (animationRef.current) {
          cancelAnimationFrame(animationRef.current);
        }
        
        // 动画结束回调
        const endTimeout = setTimeout(() => {
          setIsAnimating(false);
          onEnd?.();
        }, duration);
        
        return () => clearTimeout(endTimeout);
      };

      const delayTimeout = setTimeout(startAnimation, delay);
      return () => clearTimeout(delayTimeout);
    } else if (!trigger && isVisible) {
      // 开始隐藏动画
      setIsAnimating(true);
      
      const startHideAnimation = () => {
        setIsVisible(false);
        
        const endTimeout = setTimeout(() => {
          setIsAnimating(false);
        }, duration);
        
        return () => clearTimeout(endTimeout);
      };

      const delayTimeout = setTimeout(startHideAnimation, delay);
      return () => clearTimeout(delayTimeout);
    }
  }, [trigger, isVisible, duration, delay, disabled, onStart, onEnd]);

  const getAnimationClass = (): string => {
    if (disabled) return '';
    
    const baseClass = 'transition-wrapper';
    const typeClass = `transition-${type}`;
    const directionClass = direction ? `transition-${type}-${direction}` : '';
    const stateClass = isVisible ? 'transition-enter' : 'transition-exit';
    const animatingClass = isAnimating ? 'transition-animating' : '';
    
    return [
      baseClass,
      typeClass,
      directionClass,
      stateClass,
      animatingClass,
      className
    ].filter(Boolean).join(' ');
  };

  const getAnimationStyle = (): React.CSSProperties => {
    if (disabled) return {};
    
    return {
      transitionDuration: `${duration}ms`,
      transitionTimingFunction: easing,
      transitionProperty: getTransitionProperty(type)
    };
  };

  return (
    <div
      ref={elementRef}
      className={getAnimationClass()}
      style={getAnimationStyle()}
    >
      {children}
    </div>
  );
};

// 获取过渡属性
function getTransitionProperty(type: TransitionType): string {
  switch (type) {
    case 'fade':
      return 'opacity';
    case 'slide':
      return 'transform, opacity';
    case 'zoom':
      return 'transform, opacity';
    case 'flip':
      return 'transform';
    case 'bounce':
      return 'transform';
    default:
      return 'all';
  }
}

export default TransitionWrapper;
```

#### CSS样式实现
```css
/* TransitionWrapper.css */
.transition-wrapper {
  display: block;
  position: relative;
}

/* 淡入淡出效果 */
.transition-fade {
  opacity: 0;
}

.transition-fade.transition-enter {
  opacity: 1;
}

.transition-fade.transition-exit {
  opacity: 0;
}

/* 滑动效果 */
.transition-slide {
  opacity: 0;
  transform: translateY(20px);
}

.transition-slide-up {
  transform: translateY(20px);
}

.transition-slide-down {
  transform: translateY(-20px);
}

.transition-slide-left {
  transform: translateX(20px);
}

.transition-slide-right {
  transform: translateX(-20px);
}

.transition-slide.transition-enter {
  opacity: 1;
  transform: translate(0, 0);
}

.transition-slide.transition-exit {
  opacity: 0;
  transform: translateY(-20px);
}

/* 缩放效果 */
.transition-zoom {
  opacity: 0;
  transform: scale(0.9);
}

.transition-zoom.transition-enter {
  opacity: 1;
  transform: scale(1);
}

.transition-zoom.transition-exit {
  opacity: 0;
  transform: scale(1.1);
}

/* 翻转效果 */
.transition-flip {
  transform-style: preserve-3d;
  backface-visibility: hidden;
}

.transition-flip.transition-enter {
  animation: flipEnter 0.6s ease-out;
}

.transition-flip.transition-exit {
  animation: flipExit 0.6s ease-in;
}

@keyframes flipEnter {
  from {
    transform: perspective(400px) rotateY(-90deg);
    opacity: 0;
  }
  to {
    transform: perspective(400px) rotateY(0deg);
    opacity: 1;
  }
}

@keyframes flipExit {
  from {
    transform: perspective(400px) rotateY(0deg);
    opacity: 1;
  }
  to {
    transform: perspective(400px) rotateY(90deg);
    opacity: 0;
  }
}

/* 弹跳效果 */
.transition-bounce {
  opacity: 0;
  transform: scale(0.3);
}

.transition-bounce.transition-enter {
  opacity: 1;
  transform: scale(1);
  animation: bounceEnter 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
}

.transition-bounce.transition-exit {
  opacity: 0;
  transform: scale(0.3);
  animation: bounceExit 0.4s ease-in;
}

@keyframes bounceEnter {
  0% {
    transform: scale(0.3);
    opacity: 0;
  }
  50% {
    transform: scale(1.05);
  }
  70% {
    transform: scale(0.9);
  }
  100% {
    transform: scale(1);
    opacity: 1;
  }
}

@keyframes bounceExit {
  0% {
    transform: scale(1);
    opacity: 1;
  }
  100% {
    transform: scale(0.3);
    opacity: 0;
  }
}

/* 动画进行中状态 */
.transition-animating {
  pointer-events: none;
  user-select: none;
}

/* 性能优化 */
@media (prefers-reduced-motion: reduce) {
  .transition-wrapper {
    transition: none !important;
    animation: none !important;
  }
  
  .transition-wrapper * {
    transition: none !important;
    animation: none !important;
  }
}
```

#### 日历进度组件实现
```typescript
import React, { useMemo } from 'react';
import './CalendarProgress.css';

const CalendarProgress: React.FC<CalendarProgressProps> = ({
  currentDay,
  totalDays = 7,
  completedDays,
  onDayClick,
  theme = 'light',
  size = 'medium'
}) => {
  
  const dayItems = useMemo(() => {
    const items: DayItem[] = [];
    
    for (let day = 1; day <= totalDays; day++) {
      const isCompleted = completedDays.includes(day);
      const isCurrent = day === currentDay;
      const isUpcoming = day > currentDay;
      const isLocked = day > currentDay && !isCompleted;
      
      let status: DayStatus;
      if (isCompleted) {
        status = 'completed';
      } else if (isCurrent) {
        status = 'current';
      } else if (isUpcoming) {
        status = 'upcoming';
      } else {
        status = 'locked';
      }
      
      const isClickable = Boolean(onDayClick) && (isCompleted || (isCurrent && !isLocked));
      
      items.push({
        day,
        status,
        isClickable,
        label: `第${day}天`
      });
    }
    
    return items;
  }, [currentDay, totalDays, completedDays, onDayClick]);

  const handleDayClick = (day: number, isClickable: boolean) => {
    if (isClickable && onDayClick) {
      onDayClick(day);
    }
  };

  const getDayClass = (item: DayItem): string => {
    const baseClass = 'calendar-day';
    const statusClass = `calendar-day-${item.status}`;
    const clickableClass = item.isClickable ? 'calendar-day-clickable' : '';
    const themeClass = `calendar-theme-${theme}`;
    const sizeClass = `calendar-size-${size}`;
    
    return [
      baseClass,
      statusClass,
      clickableClass,
      themeClass,
      sizeClass
    ].filter(Boolean).join(' ');
  };

  const getProgressPercentage = (): number => {
    return (completedDays.length / totalDays) * 100;
  };

  return (
    <div className={`calendar-progress calendar-theme-${theme} calendar-size-${size}`}>
      <div className="calendar-header">
        <h3 className="calendar-title">游戏进度</h3>
        <div className="calendar-progress-bar">
          <div 
            className="calendar-progress-fill"
            style={{ width: `${getProgressPercentage()}%` }}
          />
        </div>
        <span className="calendar-progress-text">
          {completedDays.length} / {totalDays} 天完成
        </span>
      </div>
      
      <div className="calendar-grid">
        {dayItems.map((item) => (
          <div
            key={item.day}
            className={getDayClass(item)}
            onClick={() => handleDayClick(item.day, item.isClickable)}
            role={item.isClickable ? 'button' : undefined}
            tabIndex={item.isClickable ? 0 : -1}
            aria-label={item.label}
            title={item.label}
          >
            <div className="calendar-day-number">{item.day}</div>
            <div className="calendar-day-status">
              {item.status === 'completed' && '✓'}
              {item.status === 'current' && '●'}
              {item.status === 'upcoming' && '○'}
              {item.status === 'locked' && '🔒'}
            </div>
          </div>
        ))}
      </div>
      
      <div className="calendar-legend">
        <div className="calendar-legend-item">
          <span className="calendar-legend-icon completed">✓</span>
          <span>已完成</span>
        </div>
        <div className="calendar-legend-item">
          <span className="calendar-legend-icon current">●</span>
          <span>当前</span>
        </div>
        <div className="calendar-legend-item">
          <span className="calendar-legend-icon upcoming">○</span>
          <span>待进行</span>
        </div>
      </div>
    </div>
  );
};

export default CalendarProgress;
```

#### 日历进度CSS样式
```css
/* CalendarProgress.css */
.calendar-progress {
  background: var(--calendar-bg, #ffffff);
  border-radius: 12px;
  padding: 20px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  font-family: inherit;
}

.calendar-header {
  margin-bottom: 20px;
  text-align: center;
}

.calendar-title {
  margin: 0 0 12px 0;
  font-size: 1.2em;
  font-weight: 600;
  color: var(--calendar-text, #333333);
}

.calendar-progress-bar {
  width: 100%;
  height: 8px;
  background: var(--calendar-progress-bg, #e0e0e0);
  border-radius: 4px;
  overflow: hidden;
  margin-bottom: 8px;
}

.calendar-progress-fill {
  height: 100%;
  background: linear-gradient(90deg, #4CAF50, #8BC34A);
  border-radius: 4px;
  transition: width 0.3s ease;
}

.calendar-progress-text {
  font-size: 0.9em;
  color: var(--calendar-text-secondary, #666666);
}

.calendar-grid {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 8px;
  margin-bottom: 20px;
}

.calendar-day {
  aspect-ratio: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  border-radius: 8px;
  border: 2px solid transparent;
  transition: all 0.2s ease;
  position: relative;
  cursor: default;
}

.calendar-day-clickable {
  cursor: pointer;
}

.calendar-day-clickable:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.calendar-day-clickable:focus {
  outline: 2px solid #2196F3;
  outline-offset: 2px;
}

.calendar-day-number {
  font-size: 1.1em;
  font-weight: 600;
  line-height: 1;
}

.calendar-day-status {
  font-size: 0.8em;
  line-height: 1;
  margin-top: 2px;
}

/* 状态样式 */
.calendar-day-completed {
  background: linear-gradient(135deg, #4CAF50, #66BB6A);
  color: white;
  border-color: #4CAF50;
}

.calendar-day-current {
  background: linear-gradient(135deg, #2196F3, #42A5F5);
  color: white;
  border-color: #2196F3;
  animation: pulse 2s infinite;
}

.calendar-day-upcoming {
  background: var(--calendar-day-bg, #f5f5f5);
  color: var(--calendar-day-text, #666666);
  border-color: var(--calendar-day-border, #e0e0e0);
}

.calendar-day-locked {
  background: var(--calendar-day-locked-bg, #e0e0e0);
  color: var(--calendar-day-locked-text, #999999);
  border-color: var(--calendar-day-locked-border, #bdbdbd);
  opacity: 0.6;
}

/* 主题样式 */
.calendar-theme-dark {
  --calendar-bg: #2c2c2c;
  --calendar-text: #ffffff;
  --calendar-text-secondary: #b0b0b0;
  --calendar-progress-bg: #555555;
  --calendar-day-bg: #3a3a3a;
  --calendar-day-text: #e0e0e0;
  --calendar-day-border: #555555;
  --calendar-day-locked-bg: #555555;
  --calendar-day-locked-text: #888888;
  --calendar-day-locked-border: #666666;
}

.calendar-theme-light {
  --calendar-bg: #ffffff;
  --calendar-text: #333333;
  --calendar-text-secondary: #666666;
  --calendar-progress-bg: #e0e0e0;
  --calendar-day-bg: #f5f5f5;
  --calendar-day-text: #666666;
  --calendar-day-border: #e0e0e0;
  --calendar-day-locked-bg: #e0e0e0;
  --calendar-day-locked-text: #999999;
  --calendar-day-locked-border: #bdbdbd;
}

/* 尺寸样式 */
.calendar-size-small {
  padding: 12px;
}

.calendar-size-small .calendar-title {
  font-size: 1em;
  margin-bottom: 8px;
}

.calendar-size-small .calendar-grid {
  gap: 4px;
  margin-bottom: 12px;
}

.calendar-size-small .calendar-day {
  border-radius: 6px;
  border-width: 1px;
}

.calendar-size-small .calendar-day-number {
  font-size: 0.9em;
}

.calendar-size-small .calendar-day-status {
  font-size: 0.7em;
}

.calendar-size-large {
  padding: 24px;
}

.calendar-size-large .calendar-title {
  font-size: 1.4em;
  margin-bottom: 16px;
}

.calendar-size-large .calendar-grid {
  gap: 12px;
  margin-bottom: 24px;
}

.calendar-size-large .calendar-day {
  border-radius: 10px;
  border-width: 3px;
}

.calendar-size-large .calendar-day-number {
  font-size: 1.3em;
}

.calendar-size-large .calendar-day-status {
  font-size: 0.9em;
}

/* 图例 */
.calendar-legend {
  display: flex;
  justify-content: center;
  gap: 16px;
  flex-wrap: wrap;
}

.calendar-legend-item {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 0.85em;
  color: var(--calendar-text-secondary, #666666);
}

.calendar-legend-icon {
  width: 16px;
  height: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  font-size: 0.8em;
}

.calendar-legend-icon.completed {
  background: #4CAF50;
  color: white;
}

.calendar-legend-icon.current {
  background: #2196F3;
  color: white;
}

.calendar-legend-icon.upcoming {
  background: #f5f5f5;
  color: #666666;
  border: 1px solid #e0e0e0;
}

/* 动画效果 */
@keyframes pulse {
  0% {
    box-shadow: 0 0 0 0 rgba(33, 150, 243, 0.7);
  }
  70% {
    box-shadow: 0 0 0 10px rgba(33, 150, 243, 0);
  }
  100% {
    box-shadow: 0 0 0 0 rgba(33, 150, 243, 0);
  }
}

/* 响应式设计 */
@media (max-width: 480px) {
  .calendar-grid {
    grid-template-columns: repeat(4, 1fr);
  }
  
  .calendar-legend {
    flex-direction: column;
    align-items: center;
    gap: 8px;
  }
}

@media (prefers-reduced-motion: reduce) {
  .calendar-day {
    animation: none !important;
    transition: none !important;
  }
  
  .calendar-progress-fill {
    transition: none !important;
  }
}
```

#### 动画配置Hook
```typescript
import { useState, useEffect, useCallback } from 'react';

// 动画偏好配置
export interface AnimationPreferences {
  enabled: boolean;
  duration: number;
  easing: string;
  reducedMotion: boolean;
}

// 动画配置Hook
export function useAnimationConfig(userPreferences?: Partial<AnimationPreferences>) {
  const [preferences, setPreferences] = useState<AnimationPreferences>(() => {
    // 检测用户是否偏好减少动画
    const prefersReducedMotion = typeof window !== 'undefined' && 
      window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    
    return {
      enabled: !prefersReducedMotion,
      duration: 300,
      easing: 'ease-out',
      reducedMotion: prefersReducedMotion,
      ...userPreferences
    };
  });

  // 监听系统动画偏好变化
  useEffect(() => {
    if (typeof window === 'undefined') return;
    
    const mediaQuery = window.matchMedia('(prefers-reduced-motion: reduce)');
    
    const handleChange = (event: MediaQueryListEvent) => {
      setPreferences(prev => ({
        ...prev,
        enabled: !event.matches,
        reducedMotion: event.matches
      }));
    };
    
    mediaQuery.addEventListener('change', handleChange);
    return () => mediaQuery.removeEventListener('change', handleChange);
  }, []);

  // 创建动画配置
  const createAnimationConfig = useCallback((config?: Partial<AnimationConfig>): AnimationConfig => {
    if (!preferences.enabled || preferences.reducedMotion) {
      return { ...config, disabled: true };
    }
    
    return {
      duration: preferences.duration,
      easing: preferences.easing,
      ...config,
      disabled: false
    };
  }, [preferences]);

  // 更新偏好设置
  const updatePreferences = useCallback((updates: Partial<AnimationPreferences>) => {
    setPreferences(prev => ({ ...prev, ...updates }));
  }, []);

  return {
    preferences,
    createAnimationConfig,
    updatePreferences
  };
}
```

#### 使用示例
```typescript
import React, { useState } from 'react';
import TransitionWrapper from './components/ui/TransitionWrapper';
import CalendarProgress from './components/ui/CalendarProgress';
import { useAnimationConfig } from './hooks/useAnimationConfig';

const GameInterface: React.FC = () => {
  const [showContent, setShowContent] = useState(false);
  const [currentDay, setCurrentDay] = useState(3);
  const [completedDays, setCompletedDays] = useState([1, 2]);
  
  const { createAnimationConfig } = useAnimationConfig();

  const handleDayClick = (day: number) => {
    console.log(`点击了第${day}天`);
    // 处理日期点击逻辑
  };

  return (
    <div className="game-interface">
      {/* 过渡效果示例 */}
      <button onClick={() => setShowContent(!showContent)}>
        切换内容显示
      </button>
      
      <TransitionWrapper
        type="fade"
        trigger={showContent}
        config={createAnimationConfig({ duration: 500 })}
        onStart={() => console.log('动画开始')}
        onEnd={() => console.log('动画结束')}
      >
        <div className="game-content">
          <h2>游戏内容</h2>
          <p>这是一个带有淡入淡出效果的内容区域。</p>
        </div>
      </TransitionWrapper>

      {/* 日历进度示例 */}
      <TransitionWrapper
        type="bounce"
        trigger={true}
        config={createAnimationConfig({ delay: 300 })}
      >
        <CalendarProgress
          currentDay={currentDay}
          totalDays={7}
          completedDays={completedDays}
          onDayClick={handleDayClick}
          theme="light"
          size="medium"
        />
      </TransitionWrapper>

      {/* 不同类型的过渡效果 */}
      <div className="transition-examples">
        <TransitionWrapper
          type="slide"
          trigger={showContent}
          config={createAnimationConfig({ direction: 'left' })}
        >
          <div className="slide-content">滑动效果</div>
        </TransitionWrapper>

        <TransitionWrapper
          type="zoom"
          trigger={showContent}
          config={createAnimationConfig({ duration: 400 })}
        >
          <div className="zoom-content">缩放效果</div>
        </TransitionWrapper>

        <TransitionWrapper
          type="flip"
          trigger={showContent}
          config={createAnimationConfig()}
        >
          <div className="flip-content">翻转效果</div>
        </TransitionWrapper>
      </div>
    </div>
  );
};

export default GameInterface;
```