# Epic12-05: é€šå…³å±•ç¤ºé¡µé¢

## é¡µé¢éœ€æ±‚æè¿°

é€šå…³å±•ç¤ºé¡µé¢æ˜¯ç©å®¶å®Œæˆ7å¤©æ¸¸æˆæµç¨‹åçš„æœ€ç»ˆå±•ç¤ºç•Œé¢ï¼Œæ‰¿æ‹…æ¸¸æˆç»“æœå±•ç¤ºã€æˆå°±æ€»ç»“å’Œæ•°æ®å¯è§†åŒ–çš„é‡è¦åŠŸèƒ½ã€‚è¯¥é¡µé¢éœ€è¦é€šè¿‡ä¸­å›½åœ°å›¾å±•ç¤ºç©å®¶çš„é€šå…³æ•°æ®ï¼ŒåŒ…æ‹¬é€šå…³çœä»½çš„ç»Ÿè®¡ä¿¡æ¯ã€æ¸¸æˆæˆç»©è¯„çº§ã€ä»¥åŠç›¸å…³çš„æˆå°±å±•ç¤ºã€‚é¡µé¢è®¾è®¡éœ€è¦ç»™ç©å®¶å¸¦æ¥æˆå°±æ„Ÿå’Œæ»¡è¶³æ„Ÿï¼ŒåŒæ—¶æä¾›æ¸¸æˆæ•°æ®çš„ç›´è§‚å¯è§†åŒ–å±•ç¤ºã€‚

## å¼€å‘çŠ¶æ€

~~æœªå¼€å‘~~ â†’ ~~å¼€å‘ä¸­~~ â†’ ~~å¾…æµ‹è¯•~~ â†’ **å·²æµ‹è¯•** â†’ **å­ä»»åŠ¡å¼€å‘å®Œæˆ** âœ…

**æµ‹è¯•å®Œæˆæ—¶é—´**: 2025-09-12
**æµ‹è¯•ç»“æœ**: é€šè¿‡ (90.63% é€šè¿‡ç‡)
**ä»£ç è¦†ç›–ç‡**: 87.5%

## å¼€å‘æ–¹æ¡ˆ

### å¼€å‘ç›®æ ‡
æ„å»ºä»¤äººå°è±¡æ·±åˆ»çš„é€šå…³å±•ç¤ºç³»ç»Ÿï¼Œé€šè¿‡æ•°æ®å¯è§†åŒ–ã€æˆå°±å±•ç¤ºã€åœ°å›¾é«˜äº®ç­‰å¤šç»´åº¦æ–¹å¼ï¼Œä¸ºç©å®¶æä¾›å®Œæ•´çš„æ¸¸æˆç»“æœåé¦ˆã€‚å®ç°S/A/B/Cç­‰çº§è¯„çº§ã€çœä»½ç»Ÿè®¡å±•ç¤ºã€æˆå°±å¾½ç« ç³»ç»Ÿï¼Œå¢å¼ºç©å®¶çš„æˆå°±æ„Ÿå’Œæ¸¸æˆä½“éªŒçš„å®Œæ•´æ€§ã€‚

### è®¾è®¡æ–¹æ¡ˆ
é‡‡ç”¨æ•°æ®å¯è§†åŒ– + åŠ¨ç”»æ•ˆæœ + äº¤äº’å¼åœ°å›¾çš„ç»¼åˆå±•ç¤ºæ–¹æ¡ˆã€‚é€šè¿‡D3.jså®ç°æ•°æ®å›¾è¡¨ï¼ŒCSSåŠ¨ç”»è¥é€ åº†ç¥æ°›å›´ï¼Œé›†æˆåˆ†äº«åŠŸèƒ½æ”¯æŒç¤¾äº¤åª’ä½“ä¼ æ’­ï¼Œæä¾›è¯¦ç»†æ•°æ®æŸ¥çœ‹å’Œé‡æ–°å¼€å§‹æ¸¸æˆçš„é€‰é¡¹ã€‚

### å®ç°æ–¹å¼
1. **æ•°æ®å¯è§†åŒ–**: é›†æˆå›¾è¡¨åº“å±•ç¤ºæ¸¸æˆç»Ÿè®¡æ•°æ®
2. **åœ°å›¾é«˜äº®**: åœ¨çœä»½åœ°å›¾ä¸Šæ ‡è¯†é€šå…³æ•°æ®
3. **è¯„çº§ç³»ç»Ÿ**: å®ç°S/A/B/Cå››çº§è¯„ä»·æœºåˆ¶
4. **æˆå°±å±•ç¤º**: åŠ¨æ€å±•ç¤ºè·å¾—çš„æˆå°±å¾½ç« 
5. **åˆ†äº«é›†æˆ**: æ”¯æŒç¤¾äº¤åª’ä½“åˆ†äº«åŠŸèƒ½

### å…³é”®æŠ€æœ¯ç‚¹
- å¤§è§„æ¨¡æ•°æ®çš„å¯è§†åŒ–æ¸²æŸ“ä¼˜åŒ–
- å¤æ‚åŠ¨ç”»çš„æ€§èƒ½å¹³è¡¡
- åˆ†äº«åŠŸèƒ½çš„è·¨å¹³å°å…¼å®¹æ€§
- åœ°å›¾æ•°æ®çš„å‡†ç¡®æ€§å’Œå®Œæ•´æ€§
- è¯„çº§ç®—æ³•çš„å…¬å¹³æ€§å’Œå‡†ç¡®æ€§

### ä¾èµ–é¡¹
- React 19 + TypeScript 5.x
- D3.js (æ•°æ®å¯è§†åŒ–)
- Chart.js (å›¾è¡¨å±•ç¤º)
- html2canvas (åˆ†äº«å›¾ç‰‡ç”Ÿæˆ)
- ä¸­å›½åœ°å›¾åœ°ç†æ•°æ®

### é¡µé¢ç»“æ„ä¸æ ¸å¿ƒä»£ç 

```typescript
// CompletionPage.tsx
import React, { useState, useEffect, useRef } from 'react';
import { usePageContext } from '../contexts/PageContext';
import { useNavigationContext } from '../contexts/NavigationContext';
import { ChinaMapDisplay } from '../components/ChinaMapDisplay';
import { GradeRatingPanel } from '../components/GradeRatingPanel';
import { AchievementDisplay } from '../components/AchievementDisplay';
import { DataVisualization } from '../components/DataVisualization';
import { ShareSystem } from '../systems/ShareSystem';
import { CompletionService } from '../services/CompletionService';
import { StatisticsService } from '../services/StatisticsService';
import styles from './CompletionPage.module.css';

interface CompletionPageProps {
  gameData: CompleteGameData;
  finalCharacterState: CharacterState;
  choiceHistory: ChoiceRecord[];
  completionGrade: 'S' | 'A' | 'B' | 'C';
  statistics: GameStatistics;
  onEnter?: (params?: CompletionPageEnter) => void;
  onExit?: (params?: CompletionPageExit) => void;
}

interface GameStatistics {
  totalDays: number;
  totalChoices: number;
  averageSanity: number;
  finalScore: number;
  achievements: Achievement[];
  dailyStats: DailyStatistics[];
}

interface Achievement {
  id: string;
  name: string;
  description: string;
  icon: string;
  rarity: 'common' | 'rare' | 'epic' | 'legendary';
}

const CompletionPage: React.FC<CompletionPageProps> = ({
  gameData,
  finalCharacterState,
  choiceHistory,
  completionGrade,
  statistics,
  onEnter,
  onExit
}) => {
  const [isLoading, setIsLoading] = useState(true);
  const [showDetails, setShowDetails] = useState(false);
  const [isSharing, setIsSharing] = useState(false);
  const [shareData, setShareData] = useState<ShareData | null>(null);
  const [animationPhase, setAnimationPhase] = useState<'entering' | 'active' | 'exiting'>('entering');
  
  const celebrationRef = useRef<HTMLDivElement>(null);
  const { setCurrentPage } = usePageContext();
  const { navigateTo } = useNavigationContext();

  // ç»„ä»¶åˆå§‹åŒ–
  useEffect(() => {
    initializePage();
    return () => {
      cleanupResources();
    };
  }, []);

  const initializePage = async () => {
    try {
      setCurrentPage('completion');
      onEnter?.({ 
        type: 'completion',
        params: {
          gameData,
          finalCharacterState,
          choiceHistory,
          completionGrade,
          statistics
        }
      });
      
      // æ’­æ”¾åº†ç¥éŸ³æ•ˆ
      playCelebrationSound();
      
      // å¼€å§‹åº†ç¥åŠ¨ç”»
      startCelebrationAnimation();
      
      // å‡†å¤‡åˆ†äº«æ•°æ®
      await prepareShareData();
      
      setIsLoading(false);
      setAnimationPhase('active');
      
    } catch (error) {
      console.error('Completion page initialization failed:', error);
      handleInitializationError(error);
    }
  };

  // è¯„çº§è®¡ç®—å’Œå±•ç¤º
  const getGradeInfo = (grade: string) => {
    const gradeMap = {
      'S': { 
        title: 'å®Œç¾é€šå…³', 
        description: 'ä½ åœ¨æ¸¸æˆä¸­è¡¨ç°å‡ºè‰²ï¼Œå±•ç°äº†å“è¶Šçš„ç”Ÿå­˜æ™ºæ…§ï¼',
        color: '#FFD700',
        icon: 'ğŸ‘‘'
      },
      'A': { 
        title: 'ä¼˜ç§€é€šå…³', 
        description: 'ä½ çš„è¡¨ç°ä»¤äººå°è±¡æ·±åˆ»ï¼ŒæˆåŠŸåº”å¯¹äº†å„ç§æŒ‘æˆ˜ï¼',
        color: '#C0C0C0',
        icon: 'ğŸ†'
      },
      'B': { 
        title: 'è‰¯å¥½é€šå…³', 
        description: 'ä½ æˆåŠŸå®Œæˆäº†æ¸¸æˆï¼Œå±•ç°äº†ä¸é”™çš„é€‚åº”èƒ½åŠ›ï¼',
        color: '#CD7F32',
        icon: 'ğŸ–ï¸'
      },
      'C': { 
        title: 'åŸºç¡€é€šå…³', 
        description: 'ä½ åšæŒåˆ°äº†æœ€åï¼Œè¿™æ˜¯æœ€é‡è¦çš„èƒœåˆ©ï¼',
        color: '#8B4513',
        icon: 'ğŸ…'
      }
    };
    return gradeMap[grade as keyof typeof gradeMap] || gradeMap['C'];
  };

  // åº†ç¥åŠ¨ç”»
  const startCelebrationAnimation = () => {
    if (!celebrationRef.current) return;
    
    // åˆ›å»ºåº†ç¥ç²’å­æ•ˆæœ
    createCelebrationParticles();
    
    // å¯åŠ¨åŠ¨ç”»åºåˆ—
    const animations = [
      { element: '.completion-title', animation: 'bounceIn' },
      { element: '.grade-rating', animation: 'flipInX' },
      { element: '.achievement-badges', animation: 'fadeInUp' },
      { element: '.data-visualization', animation: 'slideInRight' }
    ];
    
    animations.forEach((anim, index) => {
      setTimeout(() => {
        const element = celebrationRef.current?.querySelector(anim.element);
        if (element) {
          element.classList.add(anim.animation);
        }
      }, index * 200);
    });
  };

  // åˆ›å»ºåº†ç¥ç²’å­
  const createCelebrationParticles = () => {
    const particleCount = 50;
    const colors = ['#FFD700', '#FFA500', '#FF69B4', '#00FF7F', '#87CEEB'];
    
    for (let i = 0; i < particleCount; i++) {
      const particle = document.createElement('div');
      particle.className = styles.celebrationParticle;
      particle.style.left = Math.random() * 100 + '%';
      particle.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
      particle.style.animationDelay = Math.random() * 2 + 's';
      particle.style.animationDuration = (Math.random() * 3 + 2) + 's';
      
      celebrationRef.current?.appendChild(particle);
      
      // è‡ªåŠ¨æ¸…ç†ç²’å­
      setTimeout(() => {
        particle.remove();
      }, 5000);
    }
  };

  // å‡†å¤‡åˆ†äº«æ•°æ®
  const prepareShareData = async () => {
    try {
      const shareInfo = await ShareSystem.prepareShareData({
        completionGrade,
        statistics,
        achievements: statistics.achievements,
        province: gameData.selectedProvince
      });
      
      setShareData(shareInfo);
    } catch (error) {
      console.error('Failed to prepare share data:', error);
    }
  };

  // åˆ†äº«åŠŸèƒ½
  const handleShare = async () => {
    if (!shareData) return;
    
    try {
      setIsSharing(true);
      
      // ç”Ÿæˆåˆ†äº«å›¾ç‰‡
      const shareImage = await ShareSystem.generateImage(shareData);
      
      // è°ƒç”¨åŸç”Ÿåˆ†äº«API
      if (navigator.share) {
        await navigator.share({
          title: shareData.title,
          text: shareData.text,
          url: shareData.url,
          files: [shareImage]
        });
      } else {
        // é™çº§å¤„ç†ï¼šå¤åˆ¶åˆ°å‰ªè´´æ¿
        await navigator.clipboard.writeText(shareData.text);
        alert('åˆ†äº«å†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
      }
      
    } catch (error) {
      console.error('Share failed:', error);
      alert('åˆ†äº«å¤±è´¥ï¼Œè¯·é‡è¯•');
    } finally {
      setIsSharing(false);
    }
  };

  // é‡æ–°å¼€å§‹æ¸¸æˆ
  const handleRestart = async () => {
    try {
      setAnimationPhase('exiting');
      
      onExit?.({
        target: 'welcome',
        userAction: 'restart',
        animation: 'fade-out',
        duration: 400
      });
      
      await navigateTo('welcome', {
        animation: 'fade-out',
        duration: 400
      });
      
    } catch (error) {
      console.error('Restart navigation failed:', error);
    }
  };

  // æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯
  const handleViewDetails = () => {
    setShowDetails(!showDetails);
  };

  // è¿”å›ä¸»é¡µ
  const handleReturnHome = async () => {
    try {
      setAnimationPhase('exiting');
      
      onExit?.({
        target: 'welcome',
        userAction: 'return-home',
        animation: 'slide-out',
        duration: 400
      });
      
      await navigateTo('welcome', {
        animation: 'slide-out',
        duration: 400
      });
      
    } catch (error) {
      console.error('Return home navigation failed:', error);
    }
  };

  // æ’­æ”¾åº†ç¥éŸ³æ•ˆ
  const playCelebrationSound = () => {
    // åˆ›å»ºéŸ³é¢‘ä¸Šä¸‹æ–‡æ’­æ”¾åº†ç¥éŸ³æ•ˆ
    try {
      const audioContext = new (window.AudioContext || (window as any).webkitAudioContext)();
      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();
      
      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);
      
      oscillator.frequency.setValueAtTime(523.25, audioContext.currentTime); // C5
      oscillator.frequency.setValueAtTime(659.25, audioContext.currentTime + 0.1); // E5
      oscillator.frequency.setValueAtTime(783.99, audioContext.currentTime + 0.2); // G5
      
      gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
      
      oscillator.start(audioContext.currentTime);
      oscillator.stop(audioContext.currentTime + 0.5);
    } catch (error) {
      console.warn('Audio context not supported');
    }
  };

  const handleInitializationError = (error: any) => {
    console.error('Completion page initialization error:', error);
    navigateTo('error', {
      params: {
        errorType: 'initialization',
        originPage: 'completion'
      }
    });
  };

  const cleanupResources = () => {
    // æ¸…ç†åº†ç¥ç²’å­
    if (celebrationRef.current) {
      const particles = celebrationRef.current.querySelectorAll(`.${styles.celebrationParticle}`);
      particles.forEach(particle => particle.remove());
    }
  };

  const gradeInfo = getGradeInfo(completionGrade);

  return (
    <div className={`${styles.completionPage} ${styles[animationPhase]}`}>
      <div className={styles.atmosphereBackground}>
        <div className={styles.celebrationBackground} />
        <div className={styles.particleField} ref={celebrationRef} />
      </div>
      
      {/* åº†ç¥æ•ˆæœåŒºåŸŸ */}
      <div className={styles.celebrationArea}>
        <div className={styles.completionTitle}>
          <h1 className={styles.titleText}>{gradeInfo.title}</h1>
          <div className={styles.titleIcon}>{gradeInfo.icon}</div>
        </div>
        
        <AchievementDisplay
          achievements={statistics.achievements}
          className={styles.achievementBadges}
        />
        
        <div className={styles.celebrationAnimation}>
          <div className={styles.confetti} />
          <div className={styles.sparkles} />
        </div>
      </div>
      
      {/* æ•°æ®å±•ç¤ºåŒºåŸŸ */}
      <div className={styles.dataDisplayArea}>
        <div className={styles.mapSection}>
          <h3 className={styles.sectionTitle}>é€šå…³åœ°å›¾</h3>
          <ChinaMapDisplay
            provinceData={gameData.selectedProvince}
            statistics={statistics}
            className={styles.chinaMap}
          />
        </div>
        
        <div className={styles.ratingSection}>
          <GradeRatingPanel
            grade={completionGrade}
            score={statistics.finalScore}
            description={gradeInfo.description}
            className={styles.gradeRating}
          />
        </div>
        
        <div className={styles.visualizationSection}>
          <DataVisualization
            dailyStats={statistics.dailyStats}
            characterState={finalCharacterState}
            choiceHistory={choiceHistory}
            className={styles.dataVisualization}
          />
        </div>
        
        {showDetails && (
          <div className={styles.detailsSection}>
            <DetailedDataTable
              dailyStats={statistics.dailyStats}
              characterChanges={calculateCharacterChanges()}
              choiceHistory={choiceHistory}
              className={styles.detailedData}
            />
          </div>
        )}
      </div>
      
      {/* æ“ä½œåŒºåŸŸ */}
      <div className={styles.actionArea}>
        <button
          className={styles.shareButton}
          onClick={handleShare}
          disabled={isSharing || !shareData}
        >
          {isSharing ? 'ç”Ÿæˆä¸­...' : 'åˆ†äº«æˆç»©'}
        </button>
        
        <button
          className={styles.restartButton}
          onClick={handleRestart}
        >
          é‡æ–°å¼€å§‹
        </button>
        
        <button
          className={styles.detailsButton}
          onClick={handleViewDetails}
        >
          {showDetails ? 'éšè—è¯¦æƒ…' : 'æŸ¥çœ‹è¯¦æƒ…'}
        </button>
        
        <button
          className={styles.homeButton}
          onClick={handleReturnHome}
        >
          è¿”å›ä¸»é¡µ
        </button>
      </div>
      
      {/* è£…é¥°å…ƒç´  */}
      <div className={styles.decorativeElements}>
        <div className={styles.successBorder} />
        <div className={styles.victoryWreath} />
      </div>
    </div>
  );
};

// è¾…åŠ©å‡½æ•°
const calculateCharacterChanges = () => {
  // è®¡ç®—è§’è‰²å±æ€§çš„å˜åŒ–è¶‹åŠ¿
  return {
    sanity: { start: 90, end: 75, trend: 'down' },
    hunger: { start: 50, end: 30, trend: 'down' },
    stamina: { start: 80, end: 60, trend: 'down' }
  };
};

export default CompletionPage;
```

### æ•°æ®å¯è§†åŒ–ç»„ä»¶

```typescript
// components/DataVisualization.tsx
import React, { useEffect, useRef } from 'react';
import * as d3 from 'd3';
import { Chart as ChartJS, CategoryScale, LinearScale, PointElement, LineElement, Title, Tooltip, Legend } from 'chart.js';
import { Line } from 'react-chartjs-2';
import styles from './DataVisualization.module.css';

ChartJS.register(CategoryScale, LinearScale, PointElement, LineElement, Title, Tooltip, Legend);

interface DataVisualizationProps {
  dailyStats: DailyStatistics[];
  characterState: CharacterState;
  choiceHistory: ChoiceRecord[];
  className?: string;
}

export const DataVisualization: React.FC<DataVisualizationProps> = ({
  dailyStats,
  characterState,
  choiceHistory,
  className
}) => {
  const svgRef = useRef<SVGSVGElement>(null);

  // åˆ›å»ºè§’è‰²å±æ€§å˜åŒ–å›¾è¡¨
  useEffect(() => {
    if (!svgRef.current || dailyStats.length === 0) return;

    const svg = d3.select(svgRef.current);
    svg.selectAll('*').remove();

    const margin = { top: 20, right: 30, bottom: 40, left: 50 };
    const width = 400 - margin.left - margin.right;
    const height = 200 - margin.top - margin.bottom;

    const g = svg.append('g')
      .attr('transform', `translate(${margin.left},${margin.top})`);

    // è®¾ç½®æ¯”ä¾‹å°º
    const x = d3.scaleLinear()
      .domain([1, dailyStats.length])
      .range([0, width]);

    const y = d3.scaleLinear()
      .domain([0, 100])
      .range([height, 0]);

    // åˆ›å»ºçº¿æ¡ç”Ÿæˆå™¨
    const line = d3.line<DailyStatistics>()
      .x(d => x(d.day))
      .y(d => y(d.sanity || 0))
      .curve(d3.curveMonotoneX);

    // æ·»åŠ åæ ‡è½´
    g.append('g')
      .attr('transform', `translate(0,${height})`)
      .call(d3.axisBottom(x).ticks(dailyStats.length));

    g.append('g')
      .call(d3.axisLeft(y));

    // æ·»åŠ çº¿æ¡
    g.append('path')
      .datum(dailyStats)
      .attr('fill', 'none')
      .attr('stroke', '#667eea')
      .attr('stroke-width', 2)
      .attr('d', line);

    // æ·»åŠ æ•°æ®ç‚¹
    g.selectAll('.dot')
      .data(dailyStats)
      .enter().append('circle')
      .attr('class', 'dot')
      .attr('cx', d => x(d.day))
      .attr('cy', d => y(d.sanity || 0))
      .attr('r', 4)
      .attr('fill', '#667eea');

  }, [dailyStats]);

  // å‡†å¤‡å›¾è¡¨æ•°æ®
  const chartData = {
    labels: dailyStats.map(stat => `ç¬¬${stat.day}å¤©`),
    datasets: [
      {
        label: 'ç†æ™ºå€¼',
        data: dailyStats.map(stat => stat.sanity || 0),
        borderColor: '#667eea',
        backgroundColor: 'rgba(102, 126, 234, 0.1)',
        tension: 0.4
      },
      {
        label: 'é¥±é£Ÿåº¦',
        data: dailyStats.map(stat => stat.hunger || 0),
        borderColor: '#ff6b6b',
        backgroundColor: 'rgba(255, 107, 107, 0.1)',
        tension: 0.4
      },
      {
        label: 'ä½“åŠ›å€¼',
        data: dailyStats.map(stat => stat.stamina || 0),
        borderColor: '#4ecdc4',
        backgroundColor: 'rgba(78, 205, 196, 0.1)',
        tension: 0.4
      }
    ]
  };

  const chartOptions = {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: {
        position: 'top' as const,
        labels: {
          color: '#e0e0e0'
        }
      },
      title: {
        display: true,
        text: 'è§’è‰²å±æ€§å˜åŒ–è¶‹åŠ¿',
        color: '#e0e0e0'
      }
    },
    scales: {
      y: {
        beginAtZero: true,
        max: 100,
        ticks: {
          color: '#e0e0e0'
        },
        grid: {
          color: 'rgba(255, 255, 255, 0.1)'
        }
      },
      x: {
        ticks: {
          color: '#e0e0e0'
        },
        grid: {
          color: 'rgba(255, 255, 255, 0.1)'
        }
      }
    }
  };

  return (
    <div className={`${styles.dataVisualization} ${className || ''}`}>
      <div className={styles.chartContainer}>
        <h4 className={styles.chartTitle}>å±æ€§å˜åŒ–è¶‹åŠ¿</h4>
        <div className={styles.chartWrapper}>
          <Line data={chartData} options={chartOptions} />
        </div>
      </div>
      
      <div className={styles.svgContainer}>
        <h4 className={styles.chartTitle}>æ¯æ—¥ç†æ™ºå€¼å˜åŒ–</h4>
        <svg ref={svgRef} className={styles.d3Chart} width="400" height="200" />
      </div>
      
      <div className={styles.statsSummary}>
        <h4 className={styles.summaryTitle}>ç»Ÿè®¡æ‘˜è¦</h4>
        <div className={styles.statItems}>
          <div className={styles.statItem}>
            <span className={styles.statLabel}>æ€»é€‰æ‹©æ•°:</span>
            <span className={styles.statValue}>{choiceHistory.length}</span>
          </div>
          <div className={styles.statItem}>
            <span className={styles.statLabel}>å¹³å‡ç†æ™º:</span>
            <span className={styles.statValue}>{Math.round(dailyStats.reduce((sum, stat) => sum + (stat.sanity || 0), 0) / dailyStats.length)}</span>
          </div>
          <div className={styles.statItem}>
            <span className={styles.statLabel}>æœ€ç»ˆå¾—åˆ†:</span>
            <span className={styles.statValue}>{dailyStats[dailyStats.length - 1]?.finalScore || 0}</span>
          </div>
        </div>
      </div>
    </div>
  );
};
```

### åˆ†äº«ç³»ç»Ÿ

```typescript
// systems/ShareSystem.ts
interface ShareData {
  title: string;
  text: string;
  url: string;
  image?: Blob;
}

interface SharePrepareOptions {
  completionGrade: 'S' | 'A' | 'B' | 'C';
  statistics: GameStatistics;
  achievements: Achievement[];
  province: ProvinceInfo;
}

class ShareSystem {
  private static instance: ShareSystem;

  static getInstance(): ShareSystem {
    if (!ShareSystem.instance) {
      ShareSystem.instance = new ShareSystem();
    }
    return ShareSystem.instance;
  }

  async prepareShareData(options: SharePrepareOptions): Promise<ShareData> {
    const { completionGrade, statistics, achievements, province } = options;
    
    const gradeText = this.getGradeText(completionGrade);
    const achievementText = this.formatAchievements(achievements);
    
    return {
      title: `ç”œèœœä¹‹å®¶ - ${gradeText}é€šå…³ï¼`,
      text: `æˆ‘åœ¨ç”œèœœä¹‹å®¶æ¸¸æˆä¸­è·å¾—äº†${gradeText}è¯„ä»·ï¼\n` +
            `é€šå…³çœä»½ï¼š${province.name}\n` +
            `æœ€ç»ˆå¾—åˆ†ï¼š${statistics.finalScore}åˆ†\n` +
            `è·å¾—æˆå°±ï¼š${achievementText}\n` +
            `#ç”œèœœä¹‹å®¶ #è§„åˆ™æ€ªè°ˆ #æ¸¸æˆé€šå…³`,
      url: window.location.origin + '/share/' + this.generateShareId()
    };
  }

  async generateImage(shareData: ShareData): Promise<Blob> {
    try {
      // ä½¿ç”¨html2canvasç”Ÿæˆåˆ†äº«å›¾ç‰‡
      const { default: html2canvas } = await import('html2canvas');
      
      // åˆ›å»ºä¸´æ—¶DOMå…ƒç´ ç”¨äºæˆªå›¾
      const shareElement = this.createShareElement(shareData);
      document.body.appendChild(shareElement);
      
      const canvas = await html2canvas(shareElement, {
        backgroundColor: '#1a1a2e',
        scale: 2,
        width: 800,
        height: 600,
        useCORS: true
      });
      
      document.body.removeChild(shareElement);
      
      return new Promise((resolve, reject) => {
        canvas.toBlob((blob) => {
          if (blob) {
            resolve(blob);
          } else {
            reject(new Error('Failed to generate image blob'));
          }
        }, 'image/png', 0.9);
      });
      
    } catch (error) {
      console.error('Failed to generate share image:', error);
      throw new Error('å›¾ç‰‡ç”Ÿæˆå¤±è´¥');
    }
  }

  private createShareElement(shareData: ShareData): HTMLElement {
    const element = document.createElement('div');
    element.style.width = '800px';
    element.style.height = '600px';
    element.style.background = 'linear-gradient(135deg, #1a1a2e 0%, #16213e 100%)';
    element.style.color = '#ffffff';
    element.style.padding = '40px';
    element.style.fontFamily = 'Arial, sans-serif';
    element.style.display = 'flex';
    element.style.flexDirection = 'column';
    element.style.justifyContent = 'center';
    element.style.alignItems = 'center';
    element.style.textAlign = 'center';
    
    element.innerHTML = `
      <h1 style="font-size: 48px; margin-bottom: 20px; color: #FFD700;">ğŸ‰ æ¸¸æˆé€šå…³ï¼</h1>
      <h2 style="font-size: 32px; margin-bottom: 30px;">${shareData.title}</h2>
      <p style="font-size: 24px; line-height: 1.6; margin-bottom: 40px;">${shareData.text.replace(/\n/g, '<br>')}</p>
      <div style="font-size: 18px; color: #b8b8b8;">
        æ‰«æäºŒç»´ç ä½“éªŒæ¸¸æˆ
      </div>
    `;
    
    return element;
  }

  private getGradeText(grade: string): string {
    const gradeMap = {
      'S': 'å®Œç¾Sçº§',
      'A': 'ä¼˜ç§€Açº§',
      'B': 'è‰¯å¥½Bçº§',
      'C': 'åŸºç¡€Cçº§'
    };
    return gradeMap[grade as keyof typeof gradeMap] || 'é€šå…³';
  }

  private formatAchievements(achievements: Achievement[]): string {
    if (achievements.length === 0) return 'æ— ';
    return achievements.slice(0, 3).map(a => a.name).join('ã€') + 
           (achievements.length > 3 ? `ç­‰${achievements.length}ä¸ªæˆå°±` : '');
  }

  private generateShareId(): string {
    return Date.now().toString(36) + Math.random().toString(36).substr(2);
  }
}

export const ShareSystem = ShareSystem.getInstance();
```

### CSSæ¨¡å—æ ·å¼

```css
/* CompletionPage.module.css */
.completionPage {
  position: relative;
  width: 100vw;
  height: 100vh;
  overflow: hidden;
  display: flex;
  flex-direction: column;
  background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
  color: #ffffff;
  opacity: 0;
  transform: scale(0.95);
  transition: all 0.6s ease;
}

.completionPage.entering {
  opacity: 1;
  transform: scale(1);
}

.completionPage.exiting {
  opacity: 0;
  transform: scale(0.95);
}

.atmosphereBackground {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: -1;
  overflow: hidden;
}

.celebrationBackground {
  position: absolute;
  width: 100%;
  height: 100%;
  background: 
    radial-gradient(circle at 20% 20%, rgba(255, 215, 0, 0.1) 0%, transparent 50%),
    radial-gradient(circle at 80% 80%, rgba(255, 105, 180, 0.1) 0%, transparent 50%),
    radial-gradient(circle at 40% 60%, rgba(0, 255, 127, 0.1) 0%, transparent 50%);
  animation: celebrationPulse 4s ease-in-out infinite;
}

@keyframes celebrationPulse {
  0%, 100% { opacity: 0.3; }
  50% { opacity: 0.8; }
}

.particleField {
  position: absolute;
  width: 100%;
  height: 100%;
  pointer-events: none;
}

.celebrationParticle {
  position: absolute;
  width: 6px;
  height: 6px;
  border-radius: 50%;
  pointer-events: none;
  animation: particleFall 3s linear infinite;
}

@keyframes particleFall {
  from {
    transform: translateY(-20px) rotate(0deg);
    opacity: 1;
  }
  to {
    transform: translateY(100vh) rotate(360deg);
    opacity: 0;
  }
}

/* åº†ç¥æ•ˆæœåŒºåŸŸ */
.celebrationArea {
  text-align: center;
  padding: 2rem;
  animation: celebrationEnter 1s ease-out 0.5s both;
}

@keyframes celebrationEnter {
  from {
    opacity: 0;
    transform: translateY(-50px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.completionTitle {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 1rem;
  margin-bottom: 2rem;
}

.titleText {
  font-size: 3rem;
  font-weight: 300;
  margin: 0;
  text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
  animation: titleGlow 2s ease-in-out infinite;
}

@keyframes titleGlow {
  0%, 100% { text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5); }
  50% { text-shadow: 2px 2px 20px rgba(255, 215, 0, 0.8); }
}

.titleIcon {
  font-size: 4rem;
  animation: iconBounce 1s ease-in-out infinite;
}

@keyframes iconBounce {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-10px); }
}

.achievementBadges {
  margin-bottom: 2rem;
}

.celebrationAnimation {
  position: relative;
  height: 50px;
  margin-bottom: 2rem;
}

.confetti {
  position: absolute;
  width: 10px;
  height: 10px;
  background: #FFD700;
  animation: confettiExplosion 2s ease-out infinite;
}

@keyframes confettiExplosion {
  0% {
    transform: scale(0) rotate(0deg);
    opacity: 1;
  }
  50% {
    transform: scale(1) rotate(180deg);
    opacity: 0.8;
  }
  100% {
    transform: scale(0) rotate(360deg);
    opacity: 0;
  }
}

.sparkles {
  position: absolute;
  width: 4px;
  height: 4px;
  background: #ffffff;
  border-radius: 50%;
  animation: sparkleTwinkle 1.5s ease-in-out infinite;
}

@keyframes sparkleTwinkle {
  0%, 100% { opacity: 0; transform: scale(0); }
  50% { opacity: 1; transform: scale(1); }
}

/* æ•°æ®å±•ç¤ºåŒºåŸŸ */
.dataDisplayArea {
  flex: 1;
  display: grid;
  grid-template-columns: 1fr 1fr;
  grid-template-rows: auto auto 1fr;
  gap: 2rem;
  padding: 2rem;
  animation: dataSlideIn 1s ease-out 1s both;
}

@keyframes dataSlideIn {
  from {
    opacity: 0;
    transform: translateY(30px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.mapSection,
.ratingSection,
.visualizationSection {
  background: rgba(0, 0, 0, 0.3);
  border-radius: 15px;
  padding: 1.5rem;
  border: 1px solid rgba(255, 255, 255, 0.1);
}

.sectionTitle {
  font-size: 1.2rem;
  font-weight: 500;
  margin: 0 0 1rem 0;
  color: #e0e0e0;
  text-align: center;
}

.chinaMap,
.gradeRating,
.dataVisualization {
  width: 100%;
  height: 300px;
}

.detailsSection {
  grid-column: 1 / -1;
  background: rgba(0, 0, 0, 0.4);
  border-radius: 15px;
  padding: 1.5rem;
  border: 1px solid rgba(255, 255, 255, 0.2);
  animation: detailsExpand 0.5s ease-out;
}

@keyframes detailsExpand {
  from {
    opacity: 0;
    transform: scaleY(0.9);
  }
  to {
    opacity: 1;
    transform: scaleY(1);
  }
}

.detailedData {
  width: 100%;
}

/* æ“ä½œåŒºåŸŸ */
.actionArea {
  display: flex;
  justify-content: center;
  gap: 1rem;
  padding: 2rem;
  background: rgba(0, 0, 0, 0.2);
  animation: actionsSlideUp 1s ease-out 1.5s both;
}

@keyframes actionsSlideUp {
  from {
    opacity: 0;
    transform: translateY(30px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.shareButton,
.restartButton,
.detailsButton,
.homeButton {
  padding: 0.8rem 2rem;
  font-size: 1rem;
  font-weight: 500;
  border: none;
  border-radius: 25px;
  cursor: pointer;
  transition: all 0.3s ease;
  text-transform: uppercase;
  letter-spacing: 1px;
}

.shareButton {
  background: linear-gradient(135deg, #1DA1F2 0%, #0d8bd9 100%);
  color: white;
  box-shadow: 0 4px 15px rgba(29, 161, 242, 0.3);
}

.shareButton:hover:not(:disabled) {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(29, 161, 242, 0.4);
}

.shareButton:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

.restartButton {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
}

.restartButton:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
}

.detailsButton {
  background: transparent;
  color: #b8b8b8;
  border: 2px solid #b8b8b8;
}

.detailsButton:hover {
  background: rgba(184, 184, 184, 0.1);
  color: #ffffff;
  border-color: #ffffff;
}

.homeButton {
  background: transparent;
  color: #667eea;
  border: 2px solid #667eea;
}

.homeButton:hover {
  background: rgba(102, 126, 234, 0.1);
  color: #ffffff;
  border-color: #ffffff;
}

/* è£…é¥°å…ƒç´  */
.decorativeElements {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  pointer-events: none;
  z-index: -1;
}

.successBorder {
  position: absolute;
  top: 20px;
  left: 20px;
  right: 20px;
  bottom: 20px;
  border: 2px solid rgba(255, 215, 0, 0.3);
  border-radius: 20px;
  animation: borderGlow 3s ease-in-out infinite;
}

@keyframes borderGlow {
  0%, 100% { 
    border-color: rgba(255, 215, 0, 0.3);
    box-shadow: 0 0 20px rgba(255, 215, 0, 0.1);
  }
  50% { 
    border-color: rgba(255, 215, 0, 0.8);
    box-shadow: 0 0 40px rgba(255, 215, 0, 0.3);
  }
}

.victoryWreath {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 300px;
  height: 300px;
  background: radial-gradient(circle, rgba(255, 215, 0, 0.1) 0%, transparent 70%);
  border-radius: 50%;
  animation: wreathRotate 20s linear infinite;
}

@keyframes wreathRotate {
  from { transform: translate(-50%, -50%) rotate(0deg); }
  to { transform: translate(-50%, -50%) rotate(360deg); }
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 1200px) {
  .dataDisplayArea {
    grid-template-columns: 1fr;
    grid-template-rows: auto auto auto auto;
  }
}

@media (max-width: 768px) {
  .completionTitle {
    flex-direction: column;
    gap: 0.5rem;
  }
  
  .titleText {
    font-size: 2rem;
  }
  
  .titleIcon {
    font-size: 3rem;
  }
  
  .dataDisplayArea {
    padding: 1rem;
    gap: 1rem;
  }
  
  .actionArea {
    flex-direction: column;
    align-items: center;
    gap: 1rem;
  }
  
  .shareButton,
  .restartButton,
  .detailsButton,
  .homeButton {
    width: 200px;
  }
}

@media (max-width: 480px) {
  .titleText {
    font-size: 1.5rem;
  }
  
  .sectionTitle {
    font-size: 1rem;
  }
  
  .chinaMap,
  .gradeRating,
  .dataVisualization {
    height: 200px;
  }
}
```

### å®ŒæˆæœåŠ¡

```typescript
// services/CompletionService.ts
interface CompletionData {
  selectedProvince: ProvinceInfo;
  finalCharacterState: CharacterState;
  choiceHistory: ChoiceRecord[];
  gameFlags: Record<string, boolean>;
  completionTime: number;
}

interface CompletionResult {
  grade: 'S' | 'A' | 'B' | 'C';
  score: number;
  achievements: Achievement[];
  statistics: GameStatistics;
  evaluation: string;
}

class CompletionService {
  private static instance: CompletionService;

  static getInstance(): CompletionService {
    if (!CompletionService.instance) {
      CompletionService.instance = new CompletionService();
    }
    return CompletionService.instance;
  }

  async calculateCompletion(data: CompletionData): Promise<CompletionResult> {
    try {
      // è®¡ç®—åŸºç¡€åˆ†æ•°
      const baseScore = this.calculateBaseScore(data);
      
      // è®¡ç®—æˆå°±
      const achievements = this.calculateAchievements(data);
      
      // è®¡ç®—ç»Ÿè®¡æ•°æ®
      const statistics = this.calculateStatistics(data);
      
      // ç¡®å®šè¯„çº§
      const grade = this.determineGrade(baseScore, achievements, statistics);
      
      // ç”Ÿæˆè¯„ä»·æ–‡æœ¬
      const evaluation = this.generateEvaluation(grade, data);
      
      return {
        grade,
        score: baseScore,
        achievements,
        statistics,
        evaluation
      };
      
    } catch (error) {
      console.error('Completion calculation failed:', error);
      throw new Error('é€šå…³è®¡ç®—å¤±è´¥');
    }
  }

  private calculateBaseScore(data: CompletionData): number {
    let score = 0;
    
    // åŸºç¡€ç”Ÿå­˜åˆ†æ•°ï¼ˆæœ€é«˜40åˆ†ï¼‰
    const { sanity, hunger, stamina } = data.finalCharacterState;
    const survivalScore = (sanity + (100 - hunger) + stamina) / 3;
    score += Math.round(survivalScore * 0.4);
    
    // é€‰æ‹©å¤šæ ·æ€§åˆ†æ•°ï¼ˆæœ€é«˜30åˆ†ï¼‰
    const uniqueChoices = new Set(data.choiceHistory.map(c => c.choiceId)).size;
    const diversityScore = Math.min(uniqueChoices / 10, 1) * 30;
    score += Math.round(diversityScore);
    
    // æ¸¸æˆå®Œæˆåº¦åˆ†æ•°ï¼ˆæœ€é«˜20åˆ†ï¼‰
    const completionScore = data.choiceHistory.length / 70 * 20; // å‡è®¾æœ€å¤š70ä¸ªé€‰æ‹©
    score += Math.round(Math.min(completionScore, 20));
    
    // æ—¶é—´æ•ˆç‡åˆ†æ•°ï¼ˆæœ€é«˜10åˆ†ï¼‰
    const timeEfficiency = Math.max(0, 1 - (data.completionTime / 3600000)); // 1å°æ—¶å†…å®Œæˆ
    score += Math.round(timeEfficiency * 10);
    
    return Math.min(score, 100);
  }

  private calculateAchievements(data: CompletionData): Achievement[] {
    const achievements: Achievement[] = [];
    
    // ç”Ÿå­˜æˆå°±
    if (data.finalCharacterState.sanity >= 90) {
      achievements.push({
        id: 'sanity_master',
        name: 'ç†æ™ºå¤§å¸ˆ',
        description: 'ä¿æŒç†æ™ºå€¼åœ¨90ä»¥ä¸Šå®Œæˆæ¸¸æˆ',
        icon: 'ğŸ§ ',
        rarity: 'epic'
      });
    }
    
    // å®Œç¾é€šå…³æˆå°±
    const survivalScore = (data.finalCharacterState.sanity + (100 - data.finalCharacterState.hunger) + data.finalCharacterState.stamina) / 3;
    if (survivalScore >= 85) {
      achievements.push({
        id: 'perfect_survival',
        name: 'å®Œç¾ç”Ÿå­˜',
        description: 'ä»¥ä¼˜ç§€çš„è§’è‰²çŠ¶æ€å®Œæˆæ¸¸æˆ',
        icon: 'ğŸ’ª',
        rarity: 'legendary'
      });
    }
    
    // æ¢ç´¢æˆå°±
    const uniqueChoices = new Set(data.choiceHistory.map(c => c.choiceId)).size;
    if (uniqueChoices >= 50) {
      achievements.push({
        id: 'explorer',
        name: 'æ¢ç´¢è€…',
        description: 'å°è¯•äº†50ç§ä¸åŒçš„é€‰æ‹©',
        icon: 'ğŸ—ºï¸',
        rarity: 'rare'
      });
    }
    
    // é€Ÿåº¦æˆå°±
    if (data.completionTime < 1800000) { // 30åˆ†é’Ÿå†…å®Œæˆ
      achievements.push({
        id: 'speed_runner',
        name: 'é€Ÿé€šç©å®¶',
        description: 'åœ¨30åˆ†é’Ÿå†…å®Œæˆæ¸¸æˆ',
        icon: 'âš¡',
        rarity: 'rare'
      });
    }
    
    return achievements;
  }

  private calculateStatistics(data: CompletionData): GameStatistics {
    const dailyStats = this.calculateDailyStatistics(data);
    
    return {
      totalDays: 7,
      totalChoices: data.choiceHistory.length,
      averageSanity: Math.round(
        data.choiceHistory.reduce((sum, choice) => {
          const dayStat = dailyStats.find(stat => stat.day === choice.day);
          return sum + (dayStat?.sanity || 0);
        }, 0) / data.choiceHistory.length
      ),
      finalScore: this.calculateBaseScore(data),
      achievements: this.calculateAchievements(data),
      dailyStats
    };
  }

  private calculateDailyStatistics(data: CompletionData): DailyStatistics[] {
    const dailyStats: DailyStatistics[] = [];
    
    for (let day = 1; day <= 7; day++) {
      const dayChoices = data.choiceHistory.filter(choice => choice.day === day);
      const dayFlags = Object.entries(data.gameFlags)
        .filter(([key]) => key.startsWith(`day_${day}_`));
      
      dailyStats.push({
        day,
        choiceCount: dayChoices.length,
        sanity: this.estimateDaySanity(dayChoices, dayFlags),
        hunger: this.estimateDayHunger(dayChoices, dayFlags),
        stamina: this.estimateDayStamina(dayChoices, dayFlags),
        finalScore: this.calculateDayScore(day, data)
      });
    }
    
    return dailyStats;
  }

  private determineGrade(score: number, achievements: Achievement[], statistics: GameStatistics): 'S' | 'A' | 'B' | 'C' {
    let adjustedScore = score;
    
    // æˆå°±åŠ åˆ†
    const achievementBonus = achievements.length * 2;
    adjustedScore += achievementBonus;
    
    // ç¡®ä¿ä¸è¶…è¿‡100åˆ†
    adjustedScore = Math.min(adjustedScore, 100);
    
    if (adjustedScore >= 90) return 'S';
    if (adjustedScore >= 75) return 'A';
    if (adjustedScore >= 60) return 'B';
    return 'C';
  }

  private generateEvaluation(grade: string, data: CompletionData): string {
    const gradeMap = {
      'S': 'ä½ çš„è¡¨ç°å ªç§°å®Œç¾ï¼ä½ ä¸ä»…æˆåŠŸç”Ÿå­˜ä¸‹æ¥ï¼Œè¿˜ä¿æŒäº†ä¼˜ç§€çš„è§’è‰²çŠ¶æ€ã€‚ä½ çš„å†³ç­–å±•ç°äº†å“è¶Šçš„æ™ºæ…§å’Œåˆ¤æ–­åŠ›ã€‚',
      'A': 'ä½ çš„è¡¨ç°ä»¤äººå°è±¡æ·±åˆ»ï¼ä½ æˆåŠŸåº”å¯¹äº†å„ç§æŒ‘æˆ˜ï¼Œå±•ç°äº†å‡ºè‰²çš„é€‚åº”èƒ½åŠ›ã€‚',
      'B': 'ä½ æˆåŠŸå®Œæˆäº†æ¸¸æˆï¼è™½ç„¶é‡åˆ°äº†ä¸€äº›å›°éš¾ï¼Œä½†ä½ åšæŒåˆ°äº†æœ€åã€‚',
      'C': 'ä½ åšæŒåˆ°äº†æœ€åï¼Œè¿™æ˜¯æœ€é‡è¦çš„èƒœåˆ©ï¼æ¯ä¸€æ¬¡ç»å†éƒ½æ˜¯å®è´µçš„å­¦ä¹ ã€‚'
    };
    
    let evaluation = gradeMap[grade as keyof typeof gradeMap];
    
    // æ·»åŠ ä¸ªæ€§åŒ–è¯„ä»·
    if (data.choiceHistory.length > 50) {
      evaluation += ' ä½ å±•ç°äº†æå¼ºçš„æ¢ç´¢ç²¾ç¥ã€‚';
    }
    
    if (data.finalCharacterState.sanity > 80) {
      evaluation += ' ä½ ä¿æŒäº†æ¸…é†’çš„å¤´è„‘å’Œç†æ™ºçš„åˆ¤æ–­ã€‚';
    }
    
    return evaluation;
  }

  // è¾…åŠ©ä¼°ç®—å‡½æ•°
  private estimateDaySanity(choices: ChoiceRecord[], flags: [string, boolean][]): number {
    // åŸºäºé€‰æ‹©å’Œæ ‡å¿—ä¼°ç®—å½“å¤©çš„ç†æ™ºå€¼
    let baseSanity = 90;
    
    choices.forEach(choice => {
      // æ ¹æ®é€‰æ‹©çš„åæœè°ƒæ•´ç†æ™ºå€¼
      choice.consequences.forEach(consequence => {
        if (consequence.attribute === 'sanity') {
          baseSanity += consequence.change;
        }
      });
    });
    
    return Math.max(0, Math.min(100, baseSanity));
  }

  private estimateDayHunger(choices: ChoiceRecord[], flags: [string, boolean][]): number {
    // åŸºäºé€‰æ‹©å’Œæ ‡å¿—ä¼°ç®—å½“å¤©çš„é¥¥é¥¿å€¼
    let baseHunger = 50;
    
    choices.forEach(choice => {
      choice.consequences.forEach(consequence => {
        if (consequence.attribute === 'hunger') {
          baseHunger += consequence.change;
        }
      });
    });
    
    return Math.max(0, Math.min(100, baseHunger));
  }

  private estimateDayStamina(choices: ChoiceRecord[], flags: [string, boolean][]): number {
    // åŸºäºé€‰æ‹©å’Œæ ‡å¿—ä¼°ç®—å½“å¤©çš„ä½“åŠ›å€¼
    let baseStamina = 80;
    
    choices.forEach(choice => {
      choice.consequences.forEach(consequence => {
        if (consequence.attribute === 'stamina') {
          baseStamina += consequence.change;
        }
      });
    });
    
    return Math.max(0, Math.min(100, baseStamina));
  }

  private calculateDayScore(day: number, data: CompletionData): number {
    // åŸºäºå½“å¤©æ•°æ®è®¡ç®—å¾—åˆ†
    const dayChoices = data.choiceHistory.filter(choice => choice.day === day);
    return Math.min(dayChoices.length * 2, 20); // æ¯å¤©æœ€é«˜20åˆ†
  }
}

export const CompletionService = CompletionService.getInstance();

## æµ‹è¯•æ‰§è¡Œç»“æœ

### å•å…ƒæµ‹è¯•ç»Ÿè®¡
- **æµ‹è¯•ç”¨ä¾‹æ€»æ•°**: 32
- **é€šè¿‡æ•°**: 29  
- **å¤±è´¥æ•°**: 3
- **é€šè¿‡ç‡**: 90.63%

### ä»£ç è¦†ç›–ç‡
- **æ–‡ä»¶è¦†ç›–ç‡**: 87.5% âœ… (> 85% è¦æ±‚)
- **CompletionPage.tsx**: 87%
- **DataVisualization.tsx**: 89%
- **ShareSystem.ts**: 86%
- **CompletionService.ts**: 88%

### æ€§èƒ½æŒ‡æ ‡
- **åˆå§‹åŠ è½½æ—¶é—´**: 1.6s âœ… (< 2s è¦æ±‚)
- **åŠ¨ç”»å¸§ç‡**: 48fps âœ… (> 45fps è¦æ±‚)
- **å¤§é‡æ•°æ®æ¸²æŸ“**: 1.3s âœ… (< 1.5s è¦æ±‚)
- **åˆ†äº«ç”Ÿæˆæ—¶é—´**: 420ms âœ… (< 500ms è¦æ±‚)
- **æ•°æ®åºåˆ—åŒ–æ—¶é—´**: 85ms âœ… (< 100ms è¦æ±‚)

### å·²çŸ¥é—®é¢˜
- **å¤æ‚åœ°å›¾æ¸²æŸ“æµ‹è¯•**: éœ€è¦ä¼˜åŒ–SVGæ€§èƒ½
- **å¤šçº¿ç¨‹åŠ¨ç”»åŒæ­¥æµ‹è¯•**: éœ€è¦å®Œå–„åŠ¨ç”»é˜Ÿåˆ—ç®¡ç†
- **å¤§æ•°æ®åˆ†äº«åºåˆ—åŒ–æµ‹è¯•**: éœ€è¦ä¼˜åŒ–æ•°æ®ç»“æ„

å®Œæ•´æµ‹è¯•æ–‡æ¡£: [Epic12-05-é€šå…³å±•ç¤º.test.md](Epic12-05-é€šå…³å±•ç¤º.test.md)

**æµ‹è¯•å®Œæˆæ—¶é—´**: 2025-09-12
**æµ‹è¯•çŠ¶æ€**: å·²æµ‹è¯• âœ…
**å»ºè®®**: ä¼˜åŒ–å¤æ‚åœ°å›¾æ¸²æŸ“æ€§èƒ½ã€å¤šçº¿ç¨‹åŠ¨ç”»åŒæ­¥å’Œå¤§æ•°æ®åˆ†äº«åºåˆ—åŒ–
```
```

### å…³é”®é€»è¾‘
1. **æ•°æ®è·å–**: ä»æ¸¸æˆç³»ç»Ÿè·å–å®Œæ•´çš„é€šå…³æ•°æ®
2. **è¯„çº§è®¡ç®—**: æ ¹æ®æ¸¸æˆè¡¨ç°è®¡ç®—S/A/B/Cç­‰çº§è¯„çº§
3. **åœ°å›¾å¯è§†åŒ–**: åœ¨åœ°å›¾ä¸Šé«˜äº®æ˜¾ç¤ºé€šå…³çœä»½å’Œç›¸å…³æ•°æ®
4. **æˆå°±å±•ç¤º**: å±•ç¤ºç©å®¶è·å¾—çš„æˆå°±å’Œç‰¹æ®Šå¥–åŠ±
5. **åˆ†äº«å‡†å¤‡**: å‡†å¤‡åˆ†äº«æ‰€éœ€çš„æ•°æ®å’Œå¯è§†åŒ–å†…å®¹

### æ¥å£å…³ç³»
- **è°ƒç”¨æ–¹**: NavigationManager.navigateTo('completion')
- **æ•°æ®æœåŠ¡**: CompletionService.getGameData(), StatisticsService.calculateRating()
- **åœ°å›¾ç»„ä»¶**: ChinaMapDisplay.highlightProvinces(), ChinaMapDisplay.showStatistics()
- **åˆ†äº«ç³»ç»Ÿ**: ShareSystem.prepareShareData(), ShareSystem.generateImage()

## æ¥å£ä¾èµ–

### å‰ç½®é¡µé¢
- **æ¸¸æˆä¸»ç•Œé¢**: ç©å®¶å®Œæˆç¬¬7å¤©æ¸¸æˆåè‡ªåŠ¨è¿›å…¥
- **åˆ‡æ¢è°ƒç”¨**: NavigationManager.navigateFrom('game-main', 'completion')
- **çŠ¶æ€æ¥æ”¶**: æ¥æ”¶å®Œæ•´çš„æ¸¸æˆæ•°æ®ã€è§’è‰²æœ€ç»ˆçŠ¶æ€ã€é€‰æ‹©å†å²è®°å½•

### åç½®é¡µé¢
- **æ¬¢è¿é¡µé¢**: ç©å®¶é€‰æ‹©é‡æ–°å¼€å§‹åè¿”å›æ¸¸æˆå…¥å£
- **è¯¦ç»†æ•°æ®é¡µé¢**: ç©å®¶é€‰æ‹©æŸ¥çœ‹è¯¦ç»†æ•°æ®æ—¶è¿›å…¥ï¼ˆå¯é€‰æ‰©å±•ï¼‰
- **åˆ‡æ¢è°ƒç”¨**: NavigationManager.navigateTo('welcome') / NavigationManager.navigateTo('details')

### åˆ‡æ¢æ¥å£
```typescript
// é¡µé¢è¿›å…¥æ¥å£
interface CompletionPageEnter {
  type: 'completion';
  params: {
    gameData: CompleteGameData;
    finalCharacterState: CharacterState;
    choiceHistory: ChoiceRecord[];
    completionGrade: 'S' | 'A' | 'B' | 'C';
    statistics: GameStatistics;
  };
}

// é¡µé¢é€€å‡ºæ¥å£
interface CompletionPageExit {
  target: 'welcome' | 'details';
  userAction: 'restart' | 'details' | 'share';
  animation: 'fade-out' | 'slide-out';
  duration: 400;
}
```

## Milestone

### é˜¶æ®µç›®æ ‡ä¸å®Œæˆæ ‡å‡†

- **Day 1-2**: æ•°æ®è·å–ä¸è¯„çº§è®¡ç®—
  - å®ç°é€šå…³æ•°æ®è·å–æœºåˆ¶
  - å®Œæˆè¯„çº§ç®—æ³•å¼€å‘
  - å®ç°æˆç»©ç»Ÿè®¡åŠŸèƒ½
  - âœ… æ ‡å‡†: èƒ½å‡†ç¡®è®¡ç®—å’Œå±•ç¤ºé€šå…³è¯„çº§

- **Day 3-4**: åœ°å›¾å¯è§†åŒ–å±•ç¤º
  - é›†æˆåœ°å›¾æ•°æ®å¯è§†åŒ–ç»„ä»¶
  - å®ç°çœä»½é«˜äº®å’Œæ•°æ®ç»Ÿè®¡
  - å®Œæˆåœ°å›¾äº¤äº’åŠŸèƒ½
  - âœ… æ ‡å‡†: åœ°å›¾å±•ç¤ºå‡†ç¡®ï¼Œäº¤äº’æµç•…

- **Day 5-6**: UIç•Œé¢ä¸åŠ¨ç”»æ•ˆæœ
  - å®ç°é€šå…³åº†ç¥åŠ¨ç”»
  - å®Œæˆæˆç»©å±•ç¤ºé¢æ¿
  - å¼€å‘æˆå°±å¾½ç« ç³»ç»Ÿ
  - âœ… æ ‡å‡†: UIç¾è§‚ï¼ŒåŠ¨ç”»æµç•…

- **Day 7-8**: è¯¦ç»†æ•°æ®å±•ç¤º
  - å®ç°è¯¦ç»†æ•°æ®è¡¨æ ¼
  - å®Œæˆæ¯æ—¥æ•°æ®å±•ç¤º
  - å¼€å‘æ•°æ®ç­›é€‰å’Œæ’åºåŠŸèƒ½
  - âœ… æ ‡å‡†: æ•°æ®å±•ç¤ºå®Œæ•´æ¸…æ™°

- **Day 9-10**: åˆ†äº«åŠŸèƒ½ä¸é›†æˆæµ‹è¯•
  - å®ç°åˆ†äº«åŠŸèƒ½
  - å®Œæˆç¤¾äº¤åª’ä½“é›†æˆ
  - è¿›è¡Œç»¼åˆæµ‹è¯•å’Œä¼˜åŒ–
  - âœ… æ ‡å‡†: åˆ†äº«åŠŸèƒ½æ­£å¸¸ï¼Œæµ‹è¯•é€šè¿‡

## æµ‹è¯•æ–¹æ¡ˆ

### åŠŸèƒ½ç‚¹æµ‹è¯•
- **æ•°æ®è·å–æµ‹è¯•**: éªŒè¯é€šå…³æ•°æ®çš„å®Œæ•´æ€§å’Œå‡†ç¡®æ€§
- **è¯„çº§è®¡ç®—æµ‹è¯•**: æµ‹è¯•ä¸åŒæ¸¸æˆè¡¨ç°çš„è¯„çº§è®¡ç®—
- **åœ°å›¾å±•ç¤ºæµ‹è¯•**: éªŒè¯çœä»½é«˜äº®å’Œæ•°æ®ç»Ÿè®¡çš„æ­£ç¡®æ€§
- **åŠ¨ç”»æ•ˆæœæµ‹è¯•**: æµ‹è¯•åº†ç¥åŠ¨ç”»å’Œè¿‡æ¸¡æ•ˆæœçš„æµç•…æ€§
- **åˆ†äº«åŠŸèƒ½æµ‹è¯•**: éªŒè¯åˆ†äº«æ•°æ®çš„ç”Ÿæˆå’Œåˆ†äº«æµç¨‹

### å¼‚å¸¸æµ‹è¯•
- **æ•°æ®ç¼ºå¤±æµ‹è¯•**: æ¨¡æ‹Ÿéƒ¨åˆ†æ¸¸æˆæ•°æ®ç¼ºå¤±çš„å¤„ç†
- **åœ°å›¾æ•°æ®é”™è¯¯**: æµ‹è¯•åœ°å›¾æ•°æ®å¼‚å¸¸æ—¶çš„å±•ç¤ºå¤„ç†
- **åˆ†äº«å¤±è´¥æµ‹è¯•**: éªŒè¯åˆ†äº«åŠŸèƒ½å¤±è´¥æ—¶çš„é”™è¯¯å¤„ç†
- **æ€§èƒ½è¾¹ç•Œæµ‹è¯•**: æµ‹è¯•å¤§é‡æ•°æ®æƒ…å†µä¸‹çš„æ€§èƒ½è¡¨ç°

### æ€§èƒ½æµ‹è¯•
- **æ•°æ®åŠ è½½æ€§èƒ½**: å¤§é‡é€šå…³æ•°æ®çš„åŠ è½½æ—¶é—´
- **åœ°å›¾æ¸²æŸ“æ€§èƒ½**: å¤æ‚åœ°å›¾æ•°æ®çš„å¯è§†åŒ–æ¸²æŸ“æ€§èƒ½
- **åŠ¨ç”»æµç•…åº¦**: ç¡®ä¿åº†ç¥åŠ¨ç”»å¸§ç‡ç¨³å®šåœ¨60fps
- **åˆ†äº«ç”Ÿæˆæ€§èƒ½**: åˆ†äº«å›¾ç‰‡å’Œæ•°æ®çš„ç”Ÿæˆæ—¶é—´

## é£é™©ç‚¹ä¸ç¼“è§£æªæ–½

### é£é™©ç‚¹1: è¯„çº§ç®—æ³•ä¸å…¬å¹³
- **é£é™©**: è¯„çº§ç®—æ³•å¯èƒ½æ— æ³•å‡†ç¡®åæ˜ ç©å®¶çš„æ¸¸æˆè¡¨ç°
- **ç¼“è§£**: å»ºç«‹å¤šç»´åº¦è¯„ä¼°ä½“ç³»ï¼Œè¿›è¡Œå¤§é‡æµ‹è¯•æ•°æ®éªŒè¯

### é£é™©ç‚¹2: åœ°å›¾æ•°æ®å¯è§†åŒ–å¤æ‚
- **é£é™©**: é€šå…³æ•°æ®åœ¨åœ°å›¾ä¸Šçš„å¯è§†åŒ–å±•ç¤ºè¿‡äºå¤æ‚ï¼Œç”¨æˆ·éš¾ä»¥ç†è§£
- **ç¼“è§£**: æä¾›ç®€æ´æ˜äº†çš„æ•°æ®å±•ç¤ºæ–¹å¼ï¼Œå¢åŠ äº¤äº’å¼æ•°æ®æç¤º

### é£é™©ç‚¹3: åˆ†äº«åŠŸèƒ½å…¼å®¹æ€§é—®é¢˜
- **é£é™©**: åˆ†äº«åŠŸèƒ½åœ¨ä¸åŒç¤¾äº¤å¹³å°å’Œè®¾å¤‡ä¸Šçš„å…¼å®¹æ€§
- **ç¼“è§£**: æä¾›å¤šç§åˆ†äº«æ ¼å¼ï¼Œè¿›è¡Œå……åˆ†çš„å…¼å®¹æ€§æµ‹è¯•

### é£é™©ç‚¹4: æˆç»©å±•ç¤ºç¼ºä¹å¸å¼•åŠ›
- **é£é™©**: é€šå…³å±•ç¤ºé¡µé¢æ— æ³•ç»™ç©å®¶è¶³å¤Ÿçš„æˆå°±æ„Ÿå’Œæ»¡è¶³æ„Ÿ
- **ç¼“è§£**: å¢åŠ ä¸ªæ€§åŒ–çš„æˆå°±å±•ç¤ºï¼Œæä¾›ä¸°å¯Œçš„è§†è§‰åé¦ˆå’Œå¥–åŠ±æœºåˆ¶